<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Parts Finder - Limitless LLC</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
body{background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);color:#2d3748;line-height:1.6;min-height:100vh}
.container{max-width:1200px;margin:0 auto;padding:20px}

/* Header */
.header{ text-align:center; margin-bottom:30px; padding:30px 20px; background:linear-gradient(120deg,#2c3e50 0%,#3498db 100%); color:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.15); position:relative;}
.header h1{ font-size:2.8rem; margin-bottom:10px; font-weight:700;}
.header p{ font-size:1.2rem; opacity:.9; max-width:700px; margin:0 auto;}
.cart-icon-header{ position:absolute; top:20px; right:20px; cursor:pointer; font-size:24px; color:white; display:flex; align-items:center; gap:8px;}
.cart-count{ background:#e74c3c; color:white; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:bold;}
.core-badge-header{ position:absolute; top:50px; right:20px; background:#f39c12; color:white; padding:4px 8px; border-radius:12px; font-size:12px; font-weight:600; display:none; }

/* Search */
.search-section{ background:white; border-radius:16px; padding:30px; box-shadow:0 5px 20px rgba(0,0,0,.08); margin-bottom:30px;}
.search-box{ display:flex; gap:15px; margin-bottom:25px; flex-wrap:wrap;}
.search-input{ flex:1; min-width:300px; padding:18px 22px; border:2px solid #e2e8f0; border-radius:12px; font-size:16px; transition:.3s; box-shadow:0 2px 5px rgba(0,0,0,.05);}
.search-input:focus{ border-color:#3498db; box-shadow:0 0 0 3px rgba(52,152,219,.2); outline:none;}
.search-btn{ padding:18px 32px; background:linear-gradient(120deg,#2980b9 0%,#3498db 100%); color:white; border:none; border-radius:12px; cursor:pointer; font-size:16px; font-weight:600; transition:.3s; box-shadow:0 4px 8px rgba(52,152,219,.3);}
.search-btn:hover{ transform:translateY(-2px); box-shadow:0 6px 12px rgba(52,152,219,.4);}

/* Filters */
.filters{ display:flex; gap:25px; flex-wrap:wrap; margin-bottom:20px; padding:20px; background:#f8f9fa; border-radius:12px;}
.filter-item{ display:flex; align-items:center; gap:10px;}
.filter-item input{ width:20px; height:20px; cursor:pointer;}
.filter-item label{ font-weight:500; cursor:pointer;}

/* Status */
.status{ padding:15px 0; color:4a5568; min-height:24px; display:flex; align-items:center; gap:10px;}

/* Results */
.results-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:25px; margin-bottom:40px;}
.result-card{ border:1px solid #e2e8f0; border-radius:16px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,.08); transition:.3s; background:white; display:flex; flex-direction:column; position:relative; animation:fadeIn .5s ease-out;}
.result-card:hover{ transform:translateY(-5px); box-shadow:0 12px 20px rgba(0,0,0,.15);}
.core-badge{ position:absolute; top:15px; right:15px; background:#f39c12; color:white; padding:5px 10px; border-radius:4px; font-size:11px; font-weight:600; z-index:10; box-shadow:0 2px 5px rgba(0,0,0,.2); display:flex; align-items:center; gap:5px;}
.card-image{ display:flex; align-items:center; justify-content:center; height:220px; border-bottom:1px solid #f1f1f1; background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);}
.card-image img{ max-width:85%; max-height:200px; object-fit:contain;}
.card-content{ padding:20px; flex-grow:1; display:flex; flex-direction:column;}
.part-number{ font-weight:700; margin-bottom:8px; font-size:18px; color:#2c3e50;}
.brand-uom{ font-size:14px; color:#718096; margin-bottom:12px;}
.description{ font-size:14px; color:#4a5568; margin-bottom:15px; flex-grow:1;}
.chips{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px;}
.chip{ display:inline-block; padding:6px 12px; border-radius:999px; font-size:12px; font-weight:500;}
.chip.price{ background:#ebf8ff; color:#2b6cb0; border:1px solid #bee3f8;}
.chip.stock{ background:#f0fff4; color:#2f855a; border:1px solid #c6f6d5;}
.chip.core{ background:#fff5f5; color:#c53030; border:1px solid #fed7d7;}
.alt-pns{ margin-top:12px; font-size:13px; color:#718096;}
.quantity-control{ display:flex; align-items:center; margin:15px 0; gap:10px;}
.quantity-label{ font-weight:500; color:#4a5568;}
.quantity-input{ width:70px; padding:8px 12px; border:1px solid #ddd; border-radius:6px; text-align:center;}
.qty-btn{ width:36px; height:36px; border:1px solid #ddd; background:white; border-radius:8px; cursor:pointer; font-weight:700;}
.qty-btn:active{ transform:scale(.97)}

.action-buttons{ display:flex; gap:12px; margin-top:10px;}
.action-btn{ flex:1; text-align:center; text-decoration:none; padding:12px; border-radius:10px; font-weight:500; transition:.3s; display:flex; align-items:center; justify-content:center; gap:8px; border:none; cursor:pointer;}
.cart-btn{ background:#2c3e50; color:white; border:2px solid #2c3e50;}
.cart-btn:hover{ background:#1a202c;}
.cart-btn.update{ background:#2563eb; border-color:#2563eb;}
.cart-btn.in-cart{ background:#38a169; border-color:#38a169;}
.whatsapp-btn{ background:white; color:#25D366; border:2px solid #25D366;}
.whatsapp-btn:hover{ background:#25D366; color:white;}
.inline-action{ margin-top:8px; display:flex; justify-content:flex-end; }
.remove-link{ background:none; border:none; color:#e53e3e; cursor:pointer; font-size:13px; text-decoration:underline; }

/* Inline toast */
.inline-toast{ position:absolute; top:12px; right:12px; background:#38a169; color:#fff; padding:8px 12px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.15); font-size:14px; display:flex; align-items:center; gap:8px; z-index:20; pointer-events:none; }

/* Empty state */
.empty-cart{ text-align:center; padding:40px; color:#718096; font-size:18px; }
.empty-cart i{ font-size:48px; margin-bottom:15px; opacity:0.5; }

/* Responsive */
@media (max-width:768px){
  .header h1{ font-size:2.2rem;}
  .header p{ font-size:1rem;}
  .search-box{ flex-direction:column;}
  .search-input,.search-btn{ width:100%;}
  .filters{ flex-direction:column; gap:15px;}
  .results-grid{ grid-template-columns:1fr;}
  .action-buttons{ flex-direction:column;}
  .cart-item-main{ flex-direction:column; align-items:flex-start; gap:10px;}
  .cart-icon-header{ position:relative; top:0; right:0; margin-top:15px; justify-content:center;}
  .core-badge-header{ position:relative; top:0; right:0; margin:5px auto; width:fit-content;}
}

/* Animations */
@keyframes fadeIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
.loading{ display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:#fff; animation:spin 1s ease-in-out infinite;}
@keyframes spin{ to{ transform:rotate(360deg);} }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1><i class="fas fa-search"></i> Part Finder</h1>
    <p>Search our extensive inventory of diesel engine parts</p>
    <div class="cart-icon-header" onclick="goCartPage()">
      <i class="fas fa-shopping-cart"></i>
      <div class="cart-count" id="cart-count">0</div>
    </div>
    <div class="core-badge-header" id="core-badge-header">
      <i class="fas fa-exclamation-circle"></i> Core Items
    </div>
  </div>

  <div class="search-section">
    <div class="search-box">
      <input class="search-input" id="lf-input" placeholder="Enter part number, description, or keyword..."/>
      <button class="search-btn" id="lf-btn"><i class="fas fa-search"></i> Search</button>
    </div>

    <div class="filters">
      <div class="filter-item"><input id="lf-exact" type="checkbox"/><label for="lf-exact">Exact Match</label></div>
      <div class="filter-item"><input id="lf-alt" type="checkbox" checked/><label for="lf-alt">Include Alternate Parts</label></div>
      <div class="filter-item"><input id="lf-instock" type="checkbox"/><label for="lf-instock">In Stock Only</label></div>
    </div>

    <div class="status" id="lf-status"><i class="fas fa-info-circle"></i> Loading parts catalog...</div>
  </div>

  <div class="results-grid" id="lf-results"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
(() => {
  const CSV_URL = "parts_catalog_template.csv";
  const CURRENCY_FALLBACK = "USD";
  const DECIMALS = 2;
  const CART_STORAGE_KEY = 'lf_cart';

  const $in = document.getElementById('lf-input');
  const $go = document.getElementById('lf-btn');
  const $status = document.getElementById('lf-status');
  const $results = document.getElementById('lf-results');
  const $exact = document.getElementById('lf-exact');
  const $alt = document.getElementById('lf-alt');
  const $instock = document.getElementById('lf-instock');

  const $cartCount = document.getElementById('cart-count');
  const $coreBadgeHeader = document.getElementById('core-badge-header');

  const idSafe = v => (v || "").toString().replace(/[^a-zA-Z0-9_-]/g, "_");
  const norm = s => (s || "").toString().toUpperCase().replace(/[\s\-_.]/g, "");
  const fmtMoney = (num, cur) => {
    const n = Number(num);
    if (!isFinite(n)) return String(num || "");
    return `${cur || CURRENCY_FALLBACK} ${n.toFixed(DECIMALS)}`;
  };
  const esc = s => (s ?? '').toString().replace(/[&<>"']/g, c => (
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]
  ));

  // ---- Cart helpers with consistent storage ----
  const loadCart = () => { 
    try { 
      return JSON.parse(localStorage.getItem(CART_STORAGE_KEY) || '[]'); 
    } catch(_) { 
      return []; 
    } 
  };
  
  const saveCart = (cart) => { 
    try { 
      localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart)); 
      // Trigger storage event for other tabs
      window.dispatchEvent(new StorageEvent('storage', {
        key: CART_STORAGE_KEY,
        newValue: JSON.stringify(cart)
      }));
    } catch(_){
      console.warn('Failed to save cart to localStorage');
    }
  };
  
  const syncHeader = (cart) => {
    const totalItems = cart.reduce((s,i)=>s+(Math.max(1, parseInt(i.quantity||1))),0);
    const hasCore = cart.some(i => (Number(i.core_charge)||0) > 0);
    $cartCount.textContent = totalItems;
    $coreBadgeHeader.style.display = hasCore ? 'flex' : 'none';
  };

  function addOrUpdateCartItem(partNumber, qty, price, currency, coreCharge, description, brand, uom){
    const cart = loadCart();
    const idx = cart.findIndex(x => x.part_number === partNumber);
    const item = {
      part_number: partNumber,
      name: partNumber, // Keep for compatibility
      description: description || "",
      brand: brand || "",
      uom: uom || "",
      quantity: Math.max(1, parseInt(qty||1)),
      price: Number(price) || 0,
      currency: currency || CURRENCY_FALLBACK,
      core_charge: Number(coreCharge) || 0,
      corePart: (Number(coreCharge) || 0) > 0
    };
    
    if (idx >= 0) {
      cart[idx] = item;
    } else {
      cart.push(item);
    }
    
    saveCart(cart);
    syncHeader(cart);
    return cart;
  }

  function removeFromCart(partNumber){
    const cart = loadCart().filter(i => i.part_number !== partNumber);
    saveCart(cart);
    syncHeader(cart);
    return cart;
  }

  function isInCart(partNumber) {
    const cart = loadCart();
    return cart.find(item => item.part_number === partNumber);
  }

  // Expose global functions
  window.goCartPage = () => { 
    window.location.href = 'cart.html'; 
  };

  // UI helpers for a single card
  function setButtonState(pn, state, inCart = null){
    const btn = document.getElementById(`btn-${idSafe(pn)}`);
    if (!btn) return;
    
    // Get current cart state if not provided
    if (inCart === null) {
      inCart = isInCart(pn);
    }
    
    btn.classList.remove('update', 'in-cart');
    
    if (state === 'go') {
      btn.classList.add('in-cart');
      btn.innerHTML = `<i class="fas fa-shopping-cart"></i> Go to Cart`;
      btn.dataset.state = 'go';
      btn.dataset.added = 'true';
    } else if (state === 'update') {
      btn.classList.add('update');
      btn.innerHTML = `<i class="fas fa-save"></i> Update Cart`;
      btn.dataset.state = 'update';
    } else if (inCart) {
      btn.classList.add('in-cart');
      btn.innerHTML = `<i class="fas fa-shopping-cart"></i> Go to Cart`;
      btn.dataset.state = 'go';
      btn.dataset.added = 'true';
    } else {
      btn.innerHTML = `<i class="fas fa-cart-plus"></i> Add to Cart`;
      btn.dataset.state = 'add';
      btn.dataset.added = 'false';
    }
  }

  function attachQtyHandlers(pn){
    const sid = idSafe(pn);
    const qtyInput = document.getElementById(`qty-${sid}`);
    const minus = document.getElementById(`minus-${sid}`);
    const plus = document.getElementById(`plus-${sid}`);
    if (!qtyInput) return;

    const markDirty = () => {
      const inCart = isInCart(pn);
      if (inCart && parseInt(qtyInput.value) !== parseInt(inCart.quantity)) {
        setButtonState(pn, 'update', inCart);
      }
    };
    
    qtyInput.addEventListener('input', markDirty);
    qtyInput.addEventListener('change', markDirty);
    
    if (minus) {
      minus.addEventListener('click', () => {
        const currentVal = parseInt(qtyInput.value || 1);
        const newVal = Math.max(1, currentVal - 1);
        qtyInput.value = newVal;
        markDirty();
      });
    }
    
    if (plus) {
      plus.addEventListener('click', () => {
        const currentVal = parseInt(qtyInput.value || 1);
        const newVal = currentVal + 1;
        qtyInput.value = newVal;
        markDirty();
      });
    }
  }

  window.handleCartButton = (pn, price, curr, core, desc, brand, uom) => {
    const sid = idSafe(pn);
    const qtyEl = document.getElementById(`qty-${sid}`);
    const qty = Math.max(1, parseInt(qtyEl?.value || 1));
    const btn = document.getElementById(`btn-${sid}`);
    const state = btn?.dataset.state || 'add';

    if (state === 'go') {
      window.goCartPage();
      return;
    }
    
    if (state === 'update') {
      addOrUpdateCartItem(pn, qty, price, curr, core, desc, brand, uom);
      toastOnCard(sid, 'Updated in cart');
      setButtonState(pn, 'go');
      toggleRemoveLink(pn, true);
      return;
    }
    
    // state === 'add'
    addOrUpdateCartItem(pn, qty, price, curr, core, desc, brand, uom);
    toastOnCard(sid, 'Added to cart');
    setButtonState(pn, 'go');
    toggleRemoveLink(pn, true);
  };

  window.handleRemoveFromCard = (pn) => {
    removeFromCart(pn);
    setButtonState(pn, 'add');
    const sid = idSafe(pn);
    const qtyEl = document.getElementById(`qty-${sid}`);
    if (qtyEl) qtyEl.value = 1;
    toggleRemoveLink(pn, false);
    toastOnCard(sid, 'Removed from cart');
  };

  function toggleRemoveLink(pn, show){
    const link = document.getElementById(`remove-${idSafe(pn)}`);
    if (link) link.style.display = show ? 'inline' : 'none';
  }

  function toastOnCard(sid, text){
    const card = document.querySelector(`[data-part-id="${sid}"]`) || 
                 document.getElementById(`qty-${sid}`)?.closest('.result-card');
    if (!card) return;
    
    // Remove existing toasts
    const existingToasts = card.querySelectorAll('.inline-toast');
    existingToasts.forEach(t => t.remove());
    
    const t = document.createElement('div');
    t.className = 'inline-toast';
    t.innerHTML = `<i class="fas fa-check-circle"></i> ${text}`;
    card.appendChild(t);
    setTimeout(()=>t.remove(),2000);
  }

  // Listen for cart changes from other tabs
  window.addEventListener('storage', (e) => {
    if (e.key === CART_STORAGE_KEY) {
      const cart = loadCart();
      syncHeader(cart);
      // Re-render current results to update button states
      if (currentResults.length > 0) {
        renderResults(currentResults);
      }
    }
  });

  // --------- Catalog + search ----------
  let rows = [];
  let currentResults = [];
  
  (async function loadCatalog(){
    try {
      $status.innerHTML = '<i class="fas fa-sync fa-spin"></i> Loading parts catalog...';
      const res = await fetch(CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const csvText = await res.text();
      let parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true, dynamicTyping: true });
      if (parsed.data.length && Object.keys(parsed.data[0]).length <= 1) {
        parsed = Papa.parse(csvText, { header: true, delimiter: "\t", skipEmptyLines: true, dynamicTyping: true });
      }
      rows = parsed.data.map(r => {
        const pn = (r.part_number ?? "").toString().trim();
        const alt = (r.alt_pns ?? "").toString().split(/[;,]/).map(s => s.trim()).filter(Boolean);
        return {
          ...r,
          __pn: pn,
          __pn_norm: norm(pn),
          __alts: alt,
          __alts_norm: alt.map(norm),
          __stock_num: Number(r.stock_qty ?? 0),
          __lead_num: Number(r.lead_days ?? 0),
          __price_num: Number(r.price ?? NaN),
          __core_num: Number(r.core_charge ?? 0),
          currency: r.currency || CURRENCY_FALLBACK
        };
      }).filter(x => x.__pn);
      $status.innerHTML = rows.length ? 
        `<i class="fas fa-check-circle"></i> Catalog loaded with ${rows.length} parts. Start searching above.` : 
        '<i class="fas fa-exclamation-circle"></i> No parts found in catalog.';
    } catch (e) {
      console.error('Catalog loading error:', e);
      $status.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Couldn't load catalog: ${e.message || e}`;
    }
  })();

  function fuseFor(list){
    return new Fuse(list, {
      includeScore:true,
      threshold:0.3,
      keys:[ 
        {name:"__pn",weight:0.7}, 
        {name:"alt_pns",weight:0.3}, 
        {name:"description",weight:0.2} 
      ]
    });
  }

  function renderResults(results){
    currentResults = results;
    const cart = loadCart();
    syncHeader(cart);

    if (!results.length) {
      $results.innerHTML = '<div class="empty-cart"><i class="fas fa-search"></i><br/>No matching parts found</div>';
      return;
    }

    $results.innerHTML = results.slice(0,100).map(r=>{
      const p = r.item;
      const inCart = cart.find(x => x.part_number === p.__pn);
      const qtyInCart = inCart ? inCart.quantity : 1;
      const isCore = (p.__core_num||0) > 0;
      const sid = idSafe(p.__pn);

      return `
      <div class="result-card" data-part-id="${sid}">
        ${isCore ? `<div class="core-badge" title="Core charge applies"><i class="fas fa-exclamation-circle"></i> Core</div>` : ''}
        <div class="card-image">
          <img src="${p.image_url || 'https://via.placeholder.com/300x200?text=No+Image'}" alt="${esc(p.__pn)}" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'"/>
        </div>
        <div class="card-content">
          <div class="part-number">${esc(p.__pn)}</div>
          <div class="brand-uom">${esc(p.brand || '')} | ${esc(p.uom || '')}</div>
          <div class="description">${esc(p.description || '')}</div>
          <div class="chips">
            <span class="chip price"><i class="fas fa-tag"></i> ${fmtMoney(p.__price_num, p.currency)}</span>
            <span class="chip stock"><i class="fas fa-box"></i> ${p.__stock_num>0? (p.__stock_num+' in stock'):'Out of stock'}</span>
            ${isCore ? `<span class="chip core"><i class="fas fa-exclamation-circle"></i> Core: ${fmtMoney(p.__core_num, p.currency)}</span>` : ''}
          </div>
          ${p.__alts.length ? `<div class="alt-pns"><strong>Alternates:</strong> ${esc(p.__alts.join(', '))}</div>` : ''}
          <div class="quantity-control">
            <span class="quantity-label">Quantity:</span>
            <button class="qty-btn" id="minus-${sid}" type="button">−</button>
            <input type="number" class="quantity-input" id="qty-${sid}" value="${qtyInCart}" min="1" max="${p.__stock_num>0?p.__stock_num:9999}"/>
            <button class="qty-btn" id="plus-${sid}" type="button">+</button>
          </div>
          <div class="action-buttons">
            <button 
              class="action-btn cart-btn ${inCart ? 'in-cart' : ''}" 
              id="btn-${sid}"
              data-added="${inCart ? 'true':'false'}"
              data-state="${inCart ? 'go':'add'}"
              onclick="handleCartButton('${esc(p.__pn)}', ${p.__price_num||0}, '${esc(p.currency||CURRENCY_FALLBACK)}', ${p.__core_num||0}, '${esc(p.description||'')}', '${esc(p.brand||'')}', '${esc(p.uom||'')}')">
              <i class="fas ${inCart ? 'fa-shopping-cart':'fa-cart-plus'}"></i> ${inCart ? 'Go to Cart':'Add to Cart'}
            </button>
            <a class="action-btn whatsapp-btn" href="https://wa.me/?text=${encodeURIComponent('I need information about part ' + p.__pn)}" target="_blank">
              <i class="fab fa-whatsapp"></i> WhatsApp
            </a>
          </div>
          <div class="inline-action">
            <button id="remove-${sid}" class="remove-link" style="display:${inCart?'inline':'none'}" onclick="handleRemoveFromCard('${esc(p.__pn)}')">Remove from Cart</button>
          </div>
        </div>
      </div>`;
    }).join('');

    // Attach quantity handlers after rendering
    results.slice(0,100).forEach(r => {
      attachQtyHandlers(r.item.__pn);
    });
  }

  function search(){
    const query = $in.value.trim();
    if (!query) { 
      $results.innerHTML = '<div class="empty-cart"><i class="fas fa-search"></i><br/>Enter a part number or description to search</div>'; 
      currentResults = [];
      return; 
    }
    $status.innerHTML = '<i class="fas fa-sync fa-spin"></i> Searching...';

    let results = [];
    if ($exact.checked){
      const qn = norm(query);
      const exactMatch = rows.find(r => r.__pn_norm.endsWith(qn));
      if (exactMatch) results.push({ item: exactMatch, score: 0 });
      if ($alt.checked){
        const altMatch = rows.find(r => r.__alts_norm.some(a => a.endsWith(qn)));
        if (altMatch && (!exactMatch || exactMatch.__pn !== altMatch.__pn)) results.push({ item: altMatch, score: 0.1 });
      }
    } else {
      results = fuseFor(rows).search(query);
    }

    if ($instock.checked){ 
      results = results.filter(r => r.item.__stock_num > 0); 
    }
    
    results.sort((a,b)=>(a.score||0)-(b.score||0));

    renderResults(results);
    
    if (!results.length){
      $status.innerHTML = `<i class="fas fa-info-circle"></i> No results for "${esc(query)}"`;
