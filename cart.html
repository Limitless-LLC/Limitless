<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline'; connect-src *; frame-src *;">
<title>Cart - Part Finder</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
body{background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);color:#2d3748;line-height:1.6;min-height:100vh}
.container{max-width:1200px;margin:0 auto;padding:20px}

/* Header */
.header{ text-align:center; margin-bottom:30px; padding:30px 20px; background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.15); position:relative;}
.header h1{ font-size:2.8rem; margin-bottom:10px; font-weight:700;}
.header p{ color:#718096;}
.header .home-btn{ position:absolute; left:20px; top:50%; transform:translateY(-50%); background:#2b6cb0; color:#fff; padding:10px 16px; border:none; border-radius:10px; cursor:pointer; font-weight:600; box-shadow:0 6px 16px rgba(43,108,176,.3);}
.header .home-btn i{ margin-right:8px;}

/* Grid layout */
.grid{ display:grid; grid-template-columns:2fr 1fr; gap:20px;}
@media(max-width:900px){ .grid{ grid-template-columns:1fr; } }

/* Cart */
.cart{ position:relative;}
.cart-title{ display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;}
.cart-title h2{ font-size:1.4rem;}
.cart-content{ background:white; border-radius:16px; padding:25px; box-shadow:0 5px 20px rgba(0,0,0,.08);}
.cart-items{ margin-bottom:25px; max-height:60vh; overflow-y:auto;}
.cart-item{ border:1px solid #e2e8f0; border-radius:12px; margin-bottom:15px; overflow:hidden;}
.cart-item-main{ display:flex; justify-content:space-between; padding:18px; align-items:center; background:#f8f9fa; cursor:pointer;}
.cart-item-details{ flex:1;}
.cart-item-name{ font-weight:600; margin-bottom:6px; color:#2c3e50; display:flex; align-items:center; gap:10px;}
.cart-item-description{ color:#718096; font-size:14px; margin-bottom:8px; font-style:italic;}
.cart-item-core-badge{ background:#f39c12; color:white; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:600;}
.cart-item-price{ color:#718096; font-size:14px; }
.cart-item-expand{ color:#718096; font-size:14px; transition:.3s;}
.cart-item-expand.open{ transform:rotate(180deg);}
.cart-item-core{ padding:15px; background:#fff5f5; border-top:1px solid #fed7d7; display:none;}
.cart-item-core-content{ display:flex; justify-content:space-between; align-items:center;}
.cart-item-core-info{ flex:1;}
.cart-item-core-name{ font-weight:600; color:#c53030; margin-bottom:6px;}
.cart-item-core-desc{ color:#9b2c2c; font-size:14px;}
.cart-item-core-controls input{ width:100px; padding:8px; border:1px solid #e2e8f0; border-radius:8px;}

.cart-footer{ display:flex; justify-content:space-between; align-items:center; }
.cart-summary{ background:#f7fafc; border:1px solid #e2e8f0; border-radius:12px; padding:16px;}
.cart-summary-row{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;}
.cart-summary-total{ font-weight:700; font-size:1.1rem; }

.cart-actions{ display:flex; gap:10px; }
.btn{ display:inline-flex; align-items:center; gap:8px; border:none; background:#2b6cb0; color:white; padding:12px 16px; border-radius:10px; cursor:pointer; font-weight:600; box-shadow:0 6px 16px rgba(43,108,176,.3);}
.btn.secondary{ background:#718096; }
.btn i{ font-size:14px; }

/* Customer info */
.form{ background:white; border-radius:16px; padding:25px; box-shadow:0 5px 20px rgba(0,0,0,.08); }
.form h3{ margin-bottom:12px;}
.form-row{ display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; margin-bottom:12px; }
.form-row.single{ grid-template-columns:1fr; }
.form-row input, .form-row select, .form-row textarea{ padding:10px; border:1px solid #e2e8f0; border-radius:10px; }
.form-row textarea{ min-height:80px; }
.note{ font-size:12px; color:#718096; }

/* Toasts */
.toast{ position:fixed; bottom:20px; right:20px; background:#2b6cb0; color:#fff; padding:12px 16px; border-radius:10px; box-shadow:0 6px 16px rgba(43,108,176,.3); opacity:0; transform:translateY(20px); transition:.3s; max-width:320px; z-index:9999; }
.toast.show{ opacity:1; transform:translateY(0); }
.toast.error{ background:#c53030; }

/* Validation popup */
.popup-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9998; }
.popup{ background:#fff; border-radius:14px; width:min(520px,90vw); padding:20px; box-shadow:0 20px 60px rgba(0,0,0,.3); }
.popup h3{ margin-bottom:8px; }
.popup ul{ margin-left:18px; }
.popup footer{ display:flex; justify-content:flex-end; margin-top:12px; }
.popup .btn{ background:#2b6cb0; }

</style>
</head>
<body>
  <div class="container">
    <header class="header">
      <button id="home-button" class="home-btn"><i class="fas fa-arrow-left"></i> Back to Part Finder</button>
      <h1>Your Cart</h1>
      <p>Review your items and complete your request.</p>
    </header>

    <div class="grid">
      <section class="cart">
        <div class="cart-title">
          <h2>Items</h2>
          <button id="update-cart-button" class="btn secondary"><i class="fas fa-sync"></i>Update Cart</button>
        </div>
        <div class="cart-content">
          <div id="cart-items" class="cart-items"></div>
          <div class="cart-footer">
            <div class="cart-summary">
              <div class="cart-summary-row"><span>Subtotal</span><strong id="subtotal">USD 0.00</strong></div>
              <div class="cart-summary-row"><span>Core Charges</span><strong id="core-total">USD 0.00</strong></div>
              <div class="cart-summary-row cart-summary-total"><span>Total</span><strong id="grand-total">USD 0.00</strong></div>
            </div>
            <div class="cart-actions">
              <button id="checkout-button" class="btn"><i class="fas fa-paper-plane"></i>Proceed to Checkout</button>
              <button id="clear-cart-button" class="btn secondary"><i class="fas fa-trash"></i>Clear</button>
            </div>
          </div>
        </div>
      </section>

      <section class="form">
        <h3>Customer Information</h3>
        <div class="form-row">
          <input id="customer-name" placeholder="Full Name"/>
          <input id="customer-company" placeholder="Company (optional)"/>
        </div>
        <div class="form-row">
          <input id="customer-email" placeholder="Email"/>
          <input id="customer-phone" placeholder="Phone (optional)"/>
        </div>
        <div class="form-row">
          <input id="customer-address1" placeholder="Address Line 1"/>
          <input id="customer-address2" placeholder="Address Line 2 (optional)"/>
        </div>
        <div class="form-row">
          <input id="customer-city" placeholder="City"/>
          <input id="customer-state" placeholder="State/Region"/>
        </div>
        <div class="form-row">
          <input id="customer-zip" placeholder="ZIP/Postal"/>
          <select id="customer-country">
            <option value="United States">United States</option>
            <option value="Saudi Arabia">Saudi Arabia</option>
            <option value="Oman">Oman</option>
            <option value="United Arab Emirates">United Arab Emirates</option>
            <option value="Qatar">Qatar</option>
            <option value="Kuwait">Kuwait</option>
            <option value="Bahrain">Bahrain</option>
            <option value="Jordan">Jordan</option>
            <option value="Costa Rica">Costa Rica</option>
            <option value="Peru">Peru</option>
            <option value="Guatemala">Guatemala</option>
            <option value="Paraguay">Paraguay</option>
            <option value="Mexico">Mexico</option>
            <option value="Canada">Canada</option>
            <option value="Brazil">Brazil</option>
            <option value="Argentina">Argentina</option>
            <option value="Chile">Chile</option>
            <option value="Colombia">Colombia</option>
            <option value="Panama">Panama</option>
          </select>
        </div>
        <div class="form-row">
          <input id="engine-model" placeholder="Engine Model (optional)"/>
          <input id="engine-serial" placeholder="Engine Serial (optional)"/>
        </div>
        <div class="form-row single">
          <textarea id="customer-instructions" placeholder="Special instructions (optional)"></textarea>
        </div>

        <h3>Payment Method</h3>
        <div class="form-row single">
          <select id="payment-method">
            <option value="">Select a payment method</option>
            <option value="wire">Wire Transfer (preferred)</option>
            <option value="credit_card">Credit Card</option>
            <option value="paypal">PayPal</option>
          </select>
          <div class="note" id="payment-note"></div>
        </div>
      </section>
    </div>
  </div>

  <!-- Validation Popup -->
  <div id="validation-popup" class="popup-overlay">
    <div class="popup">
      <h3>Missing required fields</h3>
      <ul id="missing-list"></ul>
      <footer>
        <button id="popup-close-btn" class="btn">OK</button>
      </footer>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toast" class="toast"></div>

<script>
// ====== Utilities ======
const DECIMALS = 2;
const CURRENCY_FALLBACK = 'USD';

window.fmtMoney = (num, cur) => { const n = Number(num); if (!isFinite(n)) return String(num ?? ""); return `${cur || CURRENCY_FALLBACK} ${n.toFixed(DECIMALS)}`; };
// expose for any legacy calls
window.CURRENCY_FALLBACK = CURRENCY_FALLBACK;
window.DECIMALS = DECIMALS;

window.esc = s => (s ?? '').toString().replace(/[&<>"']/g, c => (
  {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]
));

function showToast(msg, isError=false){
  const t=document.getElementById('toast');
  t.textContent = msg; t.className = 'toast'+(isError?' error':'');
  requestAnimationFrame(()=>{ t.classList.add('show');
    setTimeout(()=> t.classList.remove('show'), 2500);
  });
}
const showError = msg => showToast(msg, true);
const showSuccess = msg => showToast(msg, false);

// Simple helper for the Update Cart button (keeps prior behavior)
window.saveAndToast = function(){
  window.renderCart();
  showSuccess('Cart updated.');
};

// ====== Storage ======
window.loadCart = function(){
  try { return JSON.parse(localStorage.getItem('lf_cart')||'[]'); } catch(_) { return []; }
};
window.saveCart = function(items){
  localStorage.setItem('lf_cart', JSON.stringify(items||[]));
};

// ====== Render ======
window.renderCart = function(){
  const items = window.loadCart();
  const $list = document.getElementById('cart-items');
  $list.innerHTML = '';
  let subtotal = 0, coreTotal = 0;

  items.forEach((it, idx)=>{
    const qty = Math.max(1, parseInt(it.quantity||1));
    const price = Number(it.price)||0; const core=Number(it.core_charge)||0;
    subtotal += qty*price; coreTotal += qty*core;

    const $row = document.createElement('div');
    $row.className = 'cart-item';
    $row.innerHTML = `
      <div class="cart-item-main" data-idx="${idx}">
        <div class="cart-item-details">
          <div class="cart-item-name"><i class="fas fa-box"></i>${esc(it.part_number||it.name||'')}</div>
          ${it.description?`<div class="cart-item-description">${esc(it.description)}</div>`:''}
          ${it.core_charge && Number(it.core_charge)>0?`<span class="cart-item-core-badge">Core Item</span>`:''}
        </div>
        <div class="cart-item-price">${fmtMoney(price,it.currency)} × ${qty}</div>
        <div class="cart-item-expand"><i class="fas fa-chevron-down"></i></div>
      </div>
      <div class="cart-item-core">
        <div class="cart-item-core-content">
          <div class="cart-item-core-info">
            <div class="cart-item-core-name">Core Charge</div>
            <div class="cart-item-core-desc">${fmtMoney(core,it.currency)} per unit</div>
          </div>
          <div class="cart-item-core-controls">
            <label>Qty <input type="number" min="1" value="${qty}" data-idx="${idx}" class="qty-input"/></label>
            <button class="btn secondary remove-btn" data-idx="${idx}"><i class="fas fa-times"></i>Remove</button>
          </div>
        </div>
      </div>
    `;
    $list.appendChild($row);
  });

  document.getElementById('subtotal').textContent = fmtMoney(subtotal);
  document.getElementById('core-total').textContent = fmtMoney(coreTotal);
  document.getElementById('grand-total').textContent = fmtMoney(subtotal+coreTotal);

  // Toggle core panel & handlers
  $list.querySelectorAll('.cart-item-main').forEach(el=>{
    el.addEventListener('click', e=>{
      const row = el.parentElement;
      const p = el.querySelector('.cart-item-expand');
      p.classList.toggle('open');
      row.querySelector('.cart-item-core').style.display = p.classList.contains('open')?'block':'none';
    });
  });
  $list.querySelectorAll('.qty-input').forEach(inp=>{
    inp.addEventListener('change', e=>{
      const idx = parseInt(inp.getAttribute('data-idx'));
      const items = window.loadCart();
      items[idx].quantity = Math.max(1, parseInt(inp.value||1));
      window.saveCart(items);
      window.renderCart();
    });
  });
  $list.querySelectorAll('.remove-btn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const idx = parseInt(btn.getAttribute('data-idx'));
      const items = window.loadCart(); items.splice(idx,1);
      window.saveCart(items); window.renderCart();
    });
  });
};

// ====== Navigation ======
window.goHomePage = function(){
  // Navigate back to your Part Finder page
  window.location.href = 'https://limitless-llc.us/partfinder';
};

// ====== Form bindings & persistence ======
const $customerEmail = document.getElementById('customer-email');
const $customerPhone = document.getElementById('customer-phone');
const $customerCompany = document.getElementById('customer-company');
const $customerName = document.getElementById('customer-name');
const $customerAddress1 = document.getElementById('customer-address1');
const $customerAddress2 = document.getElementById('customer-address2');
const $customerCity = document.getElementById('customer-city');
const $customerState = document.getElementById('customer-state');
const $customerZip = document.getElementById('customer-zip');
const $customerCountry = document.getElementById('customer-country');
const $customerInstructions = document.getElementById('customer-instructions');
const $engineModel = document.getElementById('engine-model');
const $engineSerial = document.getElementById('engine-serial');

(function prefill(){
  try{
    const raw = localStorage.getItem('lf_customer_info');
    if(!raw) return; const v = JSON.parse(raw);
    $customerEmail.value = v.email || "";
    $customerPhone.value = v.phone || "";
    $customerCompany.value = v.company || "";
    $customerName.value = v.name || "";
    $customerAddress1.value = v.address1 || "";
    $customerAddress2.value = v.address2 || "";
    $customerCity.value = v.city || "";
    $customerState.value = v.state || "";
    $customerZip.value = v.zip || "";
    $customerCountry.value = v.country || "United States";
    $customerInstructions.value = v.instructions || "";
    $engineModel.value = v.engineModel || "";
    $engineSerial.value = v.engineSerial || "";
  }catch(_){}
})();

function persist(){
  const v = {
    email:$customerEmail.value.trim(),
    phone:$customerPhone.value.trim(),
    company:$customerCompany.value.trim(),
    name:$customerName.value.trim(),
    address1:$customerAddress1.value.trim(),
    address2:$customerAddress2.value.trim(),
    city:$customerCity.value.trim(),
    state:$customerState.value.trim(),
    zip:$customerZip.value.trim(),
    country:$customerCountry.value,
    instructions:$customerInstructions.value.trim(),
    engineModel:$engineModel.value.trim(),
    engineSerial:$engineSerial.value.trim()
  };
  localStorage.setItem('lf_customer_info', JSON.stringify(v));
}
['input','change','blur'].forEach(evt=>{
  document.querySelectorAll('#customer-name,#customer-company,#customer-email,#customer-phone,#customer-address1,#customer-address2,#customer-city,#customer-state,#customer-zip,#customer-country,#customer-instructions,#engine-model,#engine-serial').forEach(el=>{
    el.addEventListener(evt, persist);
  });
});

// ====== Payment method helper ======
const $paymentMethod = document.getElementById('payment-method');
const $paymentNote = document.getElementById('payment-note');

window.setPaymentNote = function(){
  const pm = $paymentMethod.value;
  let note = '';
  if(pm==='wire') note = 'Wire transfer preferred. Bank details will be provided on the invoice.';
  else if(pm==='credit_card') note = 'Credit cards incur a small processing fee. We will send a secure link.';
  else if(pm==='paypal') note = 'PayPal accepted. FX fees may apply for non-USD payments.';
  $paymentNote.textContent = note;
};

$paymentMethod.addEventListener('change', window.setPaymentNote);

// ====== Validation popup ======
const $validationPopup = document.getElementById('validation-popup');
const $missingList = document.getElementById('missing-list');
function showValidationPopup(list){
  $missingList.innerHTML = list.map(x=>`<li>${esc(x)}</li>`).join('');
  $validationPopup.style.display='flex';
}
function hideValidationPopup(){ $validationPopup.style.display='none'; }

// ====== Email builders ======
function buildEmailHTML(o){
  const rows = (o.items||[]).map(it=>
    `<tr><td style="padding:6px 8px;border:1px solid #e2e8f0;">${esc(it.part_number)}</td>`+
    `<td style="padding:6px 8px;border:1px solid #e2e8f0;">${esc(it.description||'')}</td>`+
    `<td style=\"padding:6px 8px;border:1px solid #e2e8f0;text-align:right;\">${it.quantity||1}</td>`+
    `<td style=\"padding:6px 8px;border:1px solid #e2e8f0;text-align:right;\">${esc(fmtMoney(it.price,it.currency))}</td>`+
    `<td style=\"padding:6px 8px;border:1px solid #e2e8f0;text-align:right;\">${esc(fmtMoney(it.core_charge||0,it.currency))}</td></tr>`
  ).join("");
  return `
  <div style="font-family:Segoe UI,Tahoma,Arial,sans-serif;font-size:14px;color:#2d3748;">
    <h2 style="margin:0 0 8px;">New RFQ</h2>
    <p style="margin:0 0 12px;">Customer <strong>${esc(o.customer.name||'')}</strong> (${esc(o.customer.company||'')}) requested a quote.</p>
    <h3 style="margin:14px 0 6px;">Items</h3>
    <table cellspacing="0" cellpadding="0" style="border-collapse:collapse;">
      <thead>
        <tr>
          <th style="text-align:left;padding:6px 8px;border:1px solid #e2e8f0;">Part #</th>
          <th style="text-align:left;padding:6px 8px;border:1px solid #e2e8f0;">Description</th>
          <th style="text-align:right;padding:6px 8px;border:1px solid #e2e8f0;">Qty</th>
          <th style="text-align:right;padding:6px 8px;border:1px solid #e2e8f0;">Price</th>
          <th style="text-align:right;padding:6px 8px;border:1px solid #e2e8f0;">Core</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
    <h3 style="margin:14px 0 6px;">Totals</h3>
    <p style="margin:0;">Subtotal: <strong>${esc(fmtMoney(o.totals.subtotal))}</strong></p>
    <p style="margin:0;">Core: <strong>${esc(fmtMoney(o.totals.coreTotal))}</strong></p>
    <p style="margin:0 0 12px;">Total: <strong>${esc(fmtMoney(o.totals.subtotal + o.totals.coreTotal))}</strong></p>
    <h3 style="margin:14px 0 6px;">Customer</h3>
    <p style="margin:0;">${esc(o.customer.name||'')} — ${esc(o.customer.company||'')}</p>
    <p style="margin:0;">${esc(o.customer.email||'')} ${o.customer.phone?(' / '+esc(o.customer.phone)) : ''}</p>
    <p style="margin:0;">${esc(o.customer.address1||'')} ${esc(o.customer.address2||'')}</p>
    <p style="margin:0;">${esc(o.customer.city||'')}, ${esc(o.customer.state||'')} ${esc(o.customer.zip||'')} — ${esc(o.customer.country||'')}</p>
    ${o.customer.engineModel||o.customer.engineSerial?(`<p style="margin:0;">Engine: ${esc(o.customer.engineModel||'')} ${esc(o.customer.engineSerial||'')}</p>`):''}
    ${o.customer.instructions?(`<p style="margin:8px 0 0;"><em>${esc(o.customer.instructions)}</em></p>`):''}
    <h3 style="margin:14px 0 6px;">Payment</h3>
    <p style="margin:0;">${esc(o.payment.method)} — ${esc(o.payment.note||'')}</p>
  </div>`;
}
function buildTextEmail(o){
  const lines = [];
  lines.push(`RFQ from ${o.customer.name||''} (${o.customer.company||''})`);
  lines.push('');
  lines.push('Items:');
  (o.items||[]).forEach(it=>{
    lines.push(`- ${it.part_number} | ${it.description||''} | Qty ${it.quantity} | ${fmtMoney(it.price,it.currency)} | Core ${fmtMoney(it.core_charge||0,it.currency)}`);
  });
  lines.push('');
  lines.push(`Subtotal: ${fmtMoney(o.totals.subtotal)}`);
  lines.push(`Core: ${fmtMoney(o.totals.coreTotal)}`);
  lines.push(`Total: ${fmtMoney(o.totals.subtotal + o.totals.coreTotal)}`);
  lines.push('');
  lines.push('Customer:');
  lines.push(`${o.customer.name||''} — ${o.customer.company||''}`);
  lines.push(`${o.customer.email||''} ${o.customer.phone?('/ '+o.customer.phone):''}`);
  lines.push(`${o.customer.address1||''} ${o.customer.address2||''}`);
  lines.push(`${o.customer.city||''}, ${o.customer.state||''} ${o.customer.zip||''} — ${o.customer.country||''}`);
  if(o.customer.engineModel||o.customer.engineSerial){ lines.push(`Engine: ${o.customer.engineModel||''} ${o.customer.engineSerial||''}`);} 
  if(o.customer.instructions){ lines.push(`Instructions: ${o.customer.instructions}`);} 
  lines.push('');
  lines.push(`Payment: ${o.payment.method} — ${o.payment.note||''}`);
  return lines.join('
');
}

// ====== Checkout ======
window.checkout = async function(){
  const cart = window.loadCart();
  if(cart.length===0){ showError('Your cart is empty.'); return; }

  const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test($customerEmail.value.trim());
  if(!emailOk){ showError('Please enter a valid email.'); $customerEmail.focus(); return; }

  const pm = $paymentMethod.value;
  if(!pm){ showError('Please select a payment method.'); $paymentMethod.focus(); return; }

  // Required fields
  const missing = [];
  if(!$customerName.value.trim()) missing.push('Full Name');
  if(!$customerEmail.value.trim()) missing.push('Email');
  if(!$customerAddress1.value.trim()) missing.push('Address Line 1');
  if(!$customerCity.value.trim()) missing.push('City');
  if(!$customerState.value.trim()) missing.push('State/Region');
  if(!$customerZip.value.trim()) missing.push('ZIP/Postal');
  if(!$customerCountry.value) missing.push('Country');
  if(missing.length){ showValidationPopup(missing); return; }

  // Totals
  let subtotal=0, coreTotal=0;
  cart.forEach(item=>{
    const qty = Math.max(1, parseInt(item.quantity||1));
    const price = Number(item.price)||0;
    const core = Number(item.core_charge)||0;
    subtotal += qty*price; coreTotal += qty*core;
  });

  const orderData = {
  totals: {
    subtotal: subtotal,
    coreTotal: coreTotal
  },
  customer: {
    email: $customerEmail.value.trim(),
    phone: $customerPhone.value.trim(),
    company: $customerCompany.value.trim(),
    name: $customerName.value.trim(),
    address1: $customerAddress1.value.trim(),
    address2: $customerAddress2.value.trim(),
    city: $customerCity.value.trim(),
    state: $customerState.value.trim(),
    zip: $customerZip.value.trim(),
    country: $customerCountry.value,
    instructions: $customerInstructions.value.trim(),
    engineModel: $engineModel.value.trim(),
    engineSerial: $engineSerial.value.trim()
  },
  shipping: {
    method: 'standard',
    country: $customerCountry.value
  },
  payment: {
    method: pm,
    note: getPaymentNoteText(pm)
  },
  email: { to: 'info@limitless-llc.us', cc: [$customerEmail.value.trim()] },
  // ↓ keep payload small for big carts
  items: cart.map(it => ({
    part_number: it.part_number || it.name || "",
    description: it.description || "",
    quantity: Math.max(1, parseInt(it.quantity || 1)),
    price: Number(it.price) || 0,
    core_charge: Number(it.core_charge) || 0,
    currency: it.currency || "USD"
  }))
};

    // Build subject/body for common CF worker patterns
const subject = `RFQ — ${orderData.customer.name || 'Customer'} — ${orderData.items.length} item(s)`;
orderData.subject = subject;
orderData.htmlBody = buildEmailHTML(orderData);
orderData.textBody = buildTextEmail(orderData);

// Send to backend
    const response = await fetch('https://lf-cart-api.pages.dev/api/checkout', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(orderData)
    });
    
    const raw = await response.text();
let data;
try { data = JSON.parse(raw); } catch { data = null; }

if (!response.ok) {
  const serverMsg = (data && (data.error || data.message)) || raw || `Server error: ${response.status}`;
  console.error('Checkout API error:', serverMsg);
  showError(serverMsg);
  return;
}

showSuccess('Order submitted! We emailed info@limitless-llc.us and CC’d you. Please check your inbox.');
window.saveCart([]);
window.renderCart();

};

function getPaymentNoteText(pm){
  if(pm==='wire') return 'Wire transfer preferred. Bank details will be provided on the invoice.';
  if(pm==='credit_card') return 'Credit cards incur a small processing fee. We will send a secure link.';
  if(pm==='paypal') return 'PayPal accepted. FX fees may apply for non-USD payments.';
  return '';
}

// Initial render
window.renderCart();
// NEW: if a method is already selected (e.g., browser autofill), reflect its note
window.setPaymentNote();

// Fix for the "goHomePage is not defined" error
document.getElementById('home-button').addEventListener('click', window.goHomePage);

// Fix for the "checkout is not defined" error
document.getElementById('checkout-button').addEventListener('click', function(){ window.checkout(); });

document.getElementById('clear-cart-button').addEventListener('click', function(){
  window.saveCart([]); window.renderCart(); showSuccess('Cart cleared.');
});

// Fix for the "update-cart-button" error
document.getElementById('update-cart-button').addEventListener('click', window.saveAndToast);

// Close popup when clicking outside
$validationPopup.addEventListener('click', function(e){ if(e.target===$validationPopup){ hideValidationPopup(); }});

document.getElementById('popup-close-btn').addEventListener('click', hideValidationPopup);
</script>
</body>
</html>
