<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline'; connect-src *; frame-src *;">
<title>Cart - Part Finder</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
body{background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);color:#2d3748;line-height:1.6;min-height:100vh}
.container{max-width:1200px;margin:0 auto;padding:20px}

/* Header */
.header{ text-align:center; margin-bottom:30px; padding:30px 20px; background:linear-gradient(120deg,#2c3e50 0%,#3498db 100%); color:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.15); position:relative;}
.header h1{ font-size:2.8rem; margin-bottom:10px; font-weight:700;}
.header p{ font-size:1.2rem; opacity:.9; max-width:700px; margin:0 auto;}
.cart-icon-header{ position:absolute; top:20px; right:20px; cursor:pointer; font-size:24px; color:white; display:flex; align-items:center; gap:8px;}
.core-badge-header{ position:absolute; top:50px; right:20px; background:#f39c12; color:white; padding:4px 8px; border-radius:12px; font-size:12px; font-weight:600; display:none; }

/* Navigation */
.nav-back{ margin-bottom:20px;}
.back-btn{ padding:12px 24px; background:#2c3e50; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:500; display:inline-flex; align-items:center; gap:8px; transition:.3s; text-decoration:none;}
.back-btn:hover{ background:#1a202c; }

/* Cart */
.cart-content{ background:white; border-radius:16px; padding:25px; box-shadow:0 5px 20px rgba(0,0,0,.08);}
.cart-items{ margin-bottom:25px; max-height:60vh; overflow-y:auto;}
.cart-item{ border:1px solid #e2e8f0; border-radius:12px; margin-bottom:15px; overflow:hidden;}
.cart-item-main{ display:flex; justify-content:space-between; padding:18px; align-items:center; background:#f8f9fa; cursor:pointer;}
.cart-item-details{ flex:1;}
.cart-item-name{ font-weight:600; margin-bottom:6px; color:#2c3e50; display:flex; align-items:center; gap:10px;}
.cart-item-description{ color:#718096; font-size:14px; margin-bottom:8px; font-style:italic;}
.cart-item-core-badge{ background:#f39c12; color:white; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:600;}
.cart-item-price{ color:#718096; font-size:14px; }
.cart-item-expand{ color:#718096; font-size:14px; transition:.3s;}
.cart-item-expand.open{ transform:rotate(180deg);}
.cart-item-core{ padding:15px; background:#fff5f5; border-top:1px solid #fed7d7; display:none;}
.cart-item-core-content{ display:flex; justify-content:space-between; align-items:center;}
.cart-item-core-info{ flex:1;}
.cart-item-core-name{ font-weight:500; margin-bottom:4px; color:#c53030;}
.cart-item-core-desc{ color:#e53e3e; font-size:13px;}
.cart-item-remove{ color:#e53e3e; background:none; border:none; cursor:pointer; padding:8px 16px; font-size:14px; border-radius:6px; transition:.3s;}
.cart-item-remove:hover{ background:#fed7d7;}
.cart-total{ font-weight:700; text-align:right; padding:20px 0; border-top:2px solid #e2e8f0; font-size:20px; color:#2c3e50;}

/* Update Cart Button */
.update-cart-btn{ padding:12px 20px; background:#2c3e50; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:500; margin-bottom:20px; display:flex; align-items:center; gap:8px; transition:.3s;}
.update-cart-btn:hover{ background:#1a202c; }

/* Customer Info + Checkout */
.customer-info-section{ background:#f8f9fa; border-radius:12px; padding:20px; margin-bottom:20px;}
.customer-info-title{ font-size:20px; color:#2c3e50; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #e2e8f0;}
.customer-form{ display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:15px;}
.form-group{ margin-bottom:15px;}
.form-label{ display:block; margin-bottom:6px; font-weight:500; color:#4a5568;}
.form-input,.form-textarea,.form-select{ width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; transition:border-color .3s;}
.form-textarea{ min-height:80px; resize:vertical;}
.form-required::after{ content:"*"; color:#e53e3e; margin-left:4px;}
.form-error{ color:#e53e3e; font-size:14px; margin-top:5px; display:none;}
.invalid{ border-color:#e53e3e !important; box-shadow:0 0 0 3px rgba(229,62,62,.15) !important; }

/* Checkout */
.checkout-section{ background:#f8f9fa; border-radius:12px; padding:20px; margin-top:20px;}
.checkout-title{ font-size:20px; color:#2c3e50; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #e2e8f0;}
.checkout-instructions{ margin-bottom:15px; color:#4a5568; line-height:1.5;}
.payment-method{ margin-bottom:15px;}
.payment-label{ display:block; margin-bottom:6px; font-weight:500; color:#4a5568;}
.payment-select{ width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; margin-bottom:8px;}
.payment-note{ color:#718096; font-size:14px; font-style:italic;}
.shipping-note{ margin-bottom:15px; padding:12px; background:#ebf8ff; border-radius:8px; color:#2b6cb0; border-left:4px solid #4299e1;}
.compliance-notes{ margin-bottom:20px;}
.compliance-note{ color:#718096; font-size:14px; margin-bottom:8px; padding-left:15px; position:relative;}
.compliance-note:before{ content:"•"; position:absolute; left:0;}
.checkout-btn{ padding:15px 30px; background:linear-gradient(120deg,#2980b9 0%,#3498db 100%); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; font-size:16px; width:100%; transition:.3s; display:flex; align-items:center; justify-content:center; gap:10px;}
.checkout-btn:hover{ transform:translateY(-2px); box-shadow:0 6px 12px rgba(52,152,219,.4);}
.checkout-helper{ margin-top:10px; text-align:center; color:#718096; font-size:14px;}

/* Error message */
.error-message{ background:#fed7d7; color:#c53030; padding:12px; border-radius:8px; margin-bottom:15px; display:none;}
.success-message{ background:#c6f6d5; color:#2f855a; padding:12px; border-radius:8px; margin-bottom:15px; display:none;}

/* Custom popup */
.custom-popup {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    display: none;
}
.popup-content {
    background: white;
    border-radius: 12px;
    padding: 25px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
.popup-title {
    font-size: 20px;
    color: #2c3e50;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e2e8f0;
}
.popup-message {
    margin-bottom: 20px;
    line-height: 1.5;
}
.popup-close-btn {
    padding: 10px 20px;
    background: #2c3e50;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    display: block;
    margin-left: auto;
}

/* Loading overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    display: none;
}
.loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* Responsive */
@media (max-width:768px){
  .header h1{ font-size:2.2rem;}
  .header p{ font-size:1rem;}
  .cart-item-main{ flex-direction:column; align-items:flex-start; gap:10px;}
  .cart-icon-header{ position:relative; top:0; right:0; margin-top:15px; justify-content:center;}
  .core-badge-header{ position:relative; top:0; right:0; margin:5px auto; width:fit-content;}
  .customer-form{ grid-template-columns:1fr;}
}

@keyframes fadeIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
@keyframes spin{ 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1><i class="fas fa-shopping-cart"></i> Your Cart</h1>
    <p>Review your items and proceed to checkout</p>
    <div class="cart-icon-header" id="home-button">
      <i class="fas fa-home"></i> Back to Search
    </div>
    <div class="core-badge-header" id="core-badge-header">
      <i class="fas fa-exclamation-circle"></i> Core Items
    </div>
  </div>

  <div class="nav-back">
    <a class="back-btn" href="index.html"><i class="fas fa-arrow-left"></i> Back to Search</a>
  </div>

  <div class="cart-content">
    <div class="error-message" id="error-message"></div>
    <div class="success-message" id="success-message"></div>
    <button class="update-cart-btn" id="update-cart-button"><i class="fas fa-sync-alt"></i> Update Cart Quantities</button>
    <div class="cart-items" id="cart-items">
      <div class="empty-cart"><i class="fas fa-shopping-cart"></i><br/> Your cart is empty</div>
    </div>
    <div class="cart-total" id="cart-total">Total: $0.00</div>

    <!-- Customer Information -->
    <div class="customer-info-section">
      <div class="customer-info-title">Customer Information</div>
      <div class="customer-form">
        <div class="form-group">
          <label class="form-label form-required" for="customer-email">Email Address</label>
          <input class="form-input" id="customer-email" placeholder="your.email@example.com" type="email"/>
          <div class="form-error" id="email-error">Please enter a valid email address</div>
        </div>
        <div class="form-group">
          <label class="form-label form-required" for="customer-phone">Phone Number</label>
          <input class="form-input" id="customer-phone" placeholder="+1 470 608 3818" type="tel"/>
          <div class="form-error" id="phone-error">Please enter a valid phone number</div>
        </div>
        <div class="form-group">
          <label class="form-label" for="customer-company">Company Name</label>
          <input class="form-input" id="customer-company" placeholder="Your Company Name" type="text"/>
        </div>
        <div class="form-group">
          <label class="form-label form-required" for="customer-name">Full Name</label>
          <input class="form-input" id="customer-name" placeholder="First and Last Name" type="text"/>
          <div class="form-error" id="name-error">Please enter your name</div>
        </div>
        <div class="form-group">
          <label class="form-label form-required" for="customer-address1">Address Line 1</label>
          <input class="form-input" id="customer-address1" placeholder="Street address, P.O. box" type="text"/>
          <div class="form-error" id="address1-error">Please enter your address</div>
        </div>
        <div class="form-group">
          <label class="form-label" for="customer-address2">Address Line 2</label>
          <input class="form-input" id="customer-address2" placeholder="Apartment, suite, unit, building, floor, etc." type="text"/>
        </div>
        <div class="form-group">
          <label class="form-label form-required" for="customer-city">City</label>
          <input class="form-input" id="customer-city" placeholder="City" type="text"/>
          <div class="form-error" id="city-error">Please enter your city</div>
        </div>
        <div class="form-group">
          <label class="form-label form-required" for="customer-state">State/Province/Region</label>
          <input class="form-input" id="customer-state" placeholder="State / Province / Region" type="text"/>
          <div class="form-error" id="state-error">Please enter your state/province</div>
        </div>
        <div class="form-group">
          <label class="form-label form-required" for="customer-zip">ZIP/Postal Code</label>
          <input class="form-input" id="customer-zip" placeholder="ZIP / Postal code" type="text"/>
          <div class="form-error" id="zip-error">Please enter your ZIP/postal code</div>
        </div>
        <div class="form-group">
          <label class="form-label form-required" for="customer-country">Country</label>
          <select class="form-select" id="customer-country">
            <option value="">Select Country</option>
            <option selected value="US">United States</option>
            <option value="CA">Canada</option>
            <option value="MX">Mexico</option>
            <option value="AR">Argentina</option>
            <option value="BR">Brazil</option>
            <option value="CL">Chile</option>
            <option value="CO">Colombia</option>
            <option value="CR">Costa Rica</option>
            <option value="DO">Dominican Republic</option>
            <option value="EC">Ecuador</option>
            <option value="SV">El Salvador</option>
            <option value="GT">Guatemala</option>
            <option value="HN">Honduras</option>
            <option value="NI">Nicaragua</option>
            <option value="PA">Panama</option>
            <option value="PE">Peru</option>
            <option value="PR">Puerto Rico</option>
            <option value="UY">Uruguay</option>
            <option value="VE">Venezuela</option>
            <option value="AE">United Arab Emirates</option>
            <option value="BH">Bahrain</option>
            <option value="EG">Egypt</option>
            <option value="IR">Iran</option>
            <option value="IQ">Iraq</option>
            <option value="IL">Israel</option>
            <option value="JO">Jordan</option>
            <option value="KW">Kuwait</option>
            <option value="LB">Lebanon</option>
            <option value="OM">Oman</option>
            <option value="QA">Qatar</option>
            <option value="SA">Saudi Arabia</option>
            <option value="TR">Turkey</option>
            <option value="AU">Australia</option>
            <option value="GB">United Kingdom</option>
            <option value="DE">Germany</option>
            <option value="FR">France</option>
            <option value="OTHER">Other</option>
          </select>
          <div class="form-error" id="country-error">Please select your country</div>
        </div>
        <div class="form-group">
          <label class="form-label" for="engine-model">Engine Model (Optional)</label>
          <input class="form-input" id="engine-model" placeholder="Engine Model" type="text"/>
        </div>
        <div class="form-group">
          <label class="form-label" for="engine-serial">Engine Serial Number (Optional)</label>
          <input class="form-input" id="engine-serial" placeholder="Engine Serial Number" type="text"/>
        </div>
        <div class="form-group" style="grid-column:1 / -1;">
          <label class="form-label" for="customer-instructions">Special Instructions</label>
          <textarea class="form-textarea" id="customer-instructions" placeholder="Any special shipping instructions or notes about your order"></textarea>
        </div>
      </div>
    </div>

    <div class="checkout-section">
      <div class="checkout-title">How Checkout Works</div>
      <div class="checkout-instructions">
        The Proceed to Checkout button does not process payment—it sends your order details to Limitless Contracting so we can confirm availability, shipping, and send you a secure payment link.
      </div>
      <div class="payment-method">
        <label class="payment-label" for="payment-method">Choose your preferred payment method:</label>
        <select class="payment-select" id="payment-method">
          <option value="">Select a payment method</option>
          <option value="credit_card">Credit Card (Visa/Mastercard/AmEx)</option>
          <option value="paypal">PayPal</option>
          <option value="bank_wire">Bank Wire</option>
          <option value="zelle">Zelle</option>
          <option value="ach">ACH (U.S. only)</option>
        </select>
        <div class="payment-note" id="payment-note"></div>
      </div>
      <div class="shipping-note">
        <strong>Shipping &amp; Handling:</strong> Calculated after we confirm weight, dimensions, and destination. You'll see the final S&amp;H on our reply email with your payment link.
      </div>
      <div class="compliance-notes">
        <div class="compliance-note">• Stock &amp; Lead Time: Availability and lead times are confirmed by email before payment.</div>
        <div class="compliance-note">• Tax: Sales tax, if applicable, is shown on your final invoice (or buyer may owe use tax).</div>
        <div class="compliance-note">• International: Duties and import charges are paid by the consignee unless otherwise agreed.</div>
      </div>
      <button class="checkout-btn" id="checkout-button"><i class="fas fa-paper-plane"></i> Proceed to Checkout</button>
      <div class="checkout-helper">This will email your order details to Limitless; you'll get a confirmation and payment link.</div>
    </div>
  </div>
</div>

<div class="loading-overlay" id="loading-overlay">
  <div class="loading-spinner"></div>
</div>

<div class="custom-popup" id="validation-popup">
  <div class="popup-content">
    <div class="popup-title">Missing Information</div>
    <div class="popup-message" id="validation-message"></div>
    <button class="popup-close-btn" id="popup-close-btn">OK</button>
  </div>
</div>

<script>
// Make these functions globally accessible
window.CURRENCY_FALLBACK = "USD";
window.DECIMALS = 2;

const $cartItems = document.getElementById('cart-items');
const $cartTotal = document.getElementById('cart-total');
const $coreBadgeHeader = document.getElementById('core-badge-header');
const $errorMessage = document.getElementById('error-message');
const $successMessage = document.getElementById('success-message');
const $loadingOverlay = document.getElementById('loading-overlay');
const $validationPopup = document.getElementById('validation-popup');
const $validationMessage = document.getElementById('validation-message');

const $paymentMethod = document.getElementById('payment-method');
const $paymentNote = document.getElementById('payment-note');

const $customerEmail = document.getElementById('customer-email');
const $customerPhone = document.getElementById('customer-phone');
const $customerCompany = document.getElementById('customer-company');
const $customerName = document.getElementById('customer-name');
const $customerAddress1 = document.getElementById('customer-address1');
const $customerAddress2 = document.getElementById('customer-address2');
const $customerCity = document.getElementById('customer-city');
const $customerState = document.getElementById('customer-state');
const $customerZip = document.getElementById('customer-zip');
const $customerCountry = document.getElementById('customer-country');
const $customerInstructions = document.getElementById('customer-instructions');
const $engineModel = document.getElementById('engine-model');
const $engineSerial = document.getElementById('engine-serial');

window.fmtMoney = (num, cur) => { 
  const n = Number(num); 
  if (!isFinite(n)) return String(num || ""); 
  return `${cur || window.CURRENCY_FALLBACK} ${n.toFixed(window.DECIMALS)}`; 
};

window.esc = s => (s ?? '').toString().replace(/[&<>"']/g, c => (
  {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]
));

function openMailSafely(url){
  try {
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (isMobile) {
      window.location.href = url; // works best on mobile
    } else {
      const a = document.createElement('a');
      a.href = url;
      a.target = '_top';
      a.rel = 'noopener';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }
  } catch (e) {
    console.warn('mailto open issue (ignored):', e);
  }
}


// Build a mailto link; if it's too long for handlers, we'll switch to a short body
function makeMailtoLink(subject, body) {
  const enc = encodeURIComponent;
  return `mailto:info@limitless-llc.us?subject=${enc(subject)}&body=${enc(body)}`;
}

// Download a CSV with the order lines so the user can attach it manually
function downloadOrderFile(orderData, orderId) {
  const rows = [["Part Number","Description","Qty","Unit Price","Core","Currency"]];
  (orderData.items || []).forEach(it => {
    rows.push([
      (it.part_number || it.name || ""),
      (it.description || ""),
      String(it.quantity || 1),
      String(Number(it.price || 0)),
      String(Number(it.core_charge || 0)),
      it.currency || "USD"
    ]);
  });
  const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const fname = `order-${orderId || Date.now()}.csv`;
  const blob = new Blob([csv], { type: 'text/csv' });

  // iOS Safari: share the file directly to Mail (or Files) if possible
  if (typeof navigator !== "undefined" && navigator.canShare && window.File) {
    try {
      const file = new File([blob], fname, { type: 'text/csv' });
      if (navigator.canShare({ files: [file] })) {
        navigator.share({ files: [file], title: fname, text: "Order CSV attached." }).catch(()=>{});
        return fname;
      }
    } catch (_) {}
  }

  // Fallback: classic "hidden link" download
  const a = document.createElement('a');
  const url = URL.createObjectURL(blob);
  a.href = url;
  a.download = fname;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 5000);
  return fname;
}


// Get payment note text
function getPaymentNoteText(paymentMethod) {
  const v = paymentMethod;
  if (v === 'credit_card') return 'Card payments incur +3.5% + $0.30 processing.';
  else if (v === 'paypal') return 'PayPal payments incur +3.9% + $0.30 processing. We\'ll send a PayPal link.';
  else if (v === 'bank_wire') return 'Bank wire transfers incur a $25 bank fee. We\'ll email you our banking details.';
  else if (v === 'zelle') return 'No processing fee. We\'ll email the Zelle instructions.';
  else if (v === 'ach') return 'No processing fee. We\'ll email the ACH instructions.';
  return '';
}

// Show error message
function showError(message) {
  $errorMessage.textContent = message;
  $errorMessage.style.display = 'block';
  $successMessage.style.display = 'none';
  setTimeout(() => {
    $errorMessage.style.display = 'none';
  }, 5000);
}

// Show success message
function showSuccess(message) {
  $successMessage.textContent = message;
  $successMessage.style.display = 'block';
  $errorMessage.style.display = 'none';
  setTimeout(() => {
    $successMessage.style.display = 'none';
  }, 5000);
}

// Show validation popup
function showValidationPopup(message) {
  $validationMessage.textContent = message;
  $validationPopup.style.display = 'flex';
}

// Hide validation popup
function hideValidationPopup() {
  $validationPopup.style.display = 'none';
}

// Show/hide loading
function setLoading(loading) {
  $loadingOverlay.style.display = loading ? 'flex' : 'none';
}

// NEW: show payment note text based on selection
window.setPaymentNote = function() {
  $paymentNote.textContent = getPaymentNoteText($paymentMethod.value);
};

window.loadCart = function() { 
  try { 
    return JSON.parse(localStorage.getItem('lf_cart') || '[]'); 
  } catch(_) { 
    return []; 
  } 
};

window.saveCart = function(cart) { 
  try { 
    localStorage.setItem('lf_cart', JSON.stringify(cart)); 
  } catch(_){} 
};

window.renderCart = function() {
  const cart = window.loadCart();
  if (cart.length === 0) {
    $cartItems.innerHTML = '<div class="empty-cart"><i class="fas fa-shopping-cart"></i><br/> Your cart is empty</div>';
    $cartTotal.textContent = 'Total: $0.00';
    $coreBadgeHeader.style.display = 'none';
    return;
  }
  
  let html = '', subtotal = 0, coreTotal = 0, hasCore = false;
  
  // Use event delegation for better performance with many items
  cart.forEach((item, i) => {
    const qty = Math.max(1, parseInt(item.quantity || 1));
    const price = Number(item.price) || 0;
    const core = Number(item.core_charge) || 0;
    subtotal += qty * price; 
    coreTotal += qty * core; 
    if (core > 0) hasCore = true;
    
    html += `
      <div class="cart-item" data-index="${i}">
        <div class="cart-item-main" data-action="toggle" data-index="${i}">
          <div class="cart-item-details">
            <div class="cart-item-name">${window.esc(item.part_number || item.name || 'Item')} ${core > 0 ? '<span class="cart-item-core-badge">CORE</span>' : ''}</div>
            <div class="cart-item-description">${window.esc(item.description || '')}</div>
            <div class="cart-item-price">
              ${window.fmtMoney(price, item.currency)} × 
              <input type="number" min="1" value="${qty}" data-action="updateQty" data-index="${i}" style="width:60px;padding:4px;border:1px solid #ddd;border-radius:4px">
              = ${window.fmtMoney(qty * price, item.currency)}
            </div>
          </div>
          <div class="cart-item-expand"><i class="fas fa-chevron-down"></i></div>
        </div>
        ${core > 0 ? `
          <div class="cart-item-core" style="display:none;">
            <div class="cart-item-core-content">
              <div class="cart-item-core-info">
                <div class="cart-item-core-name">Core Charge: ${window.fmtMoney(core, item.currency)} × ${qty}</div>
                <div class="cart-item-core-desc">Refundable on eligible core return.</div>
              </div>
              <button class="cart-item-remove" data-action="remove" data-index="${i}"><i class="fas fa-trash"></i> Remove</button>
            </div>
          </div>` :
          `<div class="cart-item-core" style="display:none;">
             <div class="cart-item-core-content">
               <div class="cart-item-core-info"></div>
               <button class="cart-item-remove" data-action="remove" data-index="${i}"><i class="fas fa-trash"></i> Remove</button>
             </div>
           </div>`}
      </div>`;
  });
  
  $cartItems.innerHTML = html;
  $cartTotal.textContent = `Total: ${window.fmtMoney(subtotal, 'USD')}${hasCore ? ` + Core: ${window.fmtMoney(coreTotal, 'USD')}` : ''}`;
  $coreBadgeHeader.style.display = hasCore ? 'flex' : 'none';
};

// Event delegation for better performance
$cartItems.addEventListener('click', function(e) {
  const target = e.target;
  const action = target.getAttribute('data-action') || 
                target.closest('[data-action]')?.getAttribute('data-action');
  const index = target.getAttribute('data-index') || 
               target.closest('[data-index]')?.getAttribute('data-index');
  
  if (action === 'toggle' && index !== null) {
    window.toggleCore(parseInt(index));
  } else if (action === 'remove' && index !== null) {
    window.removeItem(parseInt(index));
  }
});

$cartItems.addEventListener('change', function(e) {
  if (e.target.getAttribute('data-action') === 'updateQty') {
    const index = e.target.getAttribute('data-index');
    if (index !== null) {
      window.updateQty(parseInt(index), e.target.value);
    }
  }
});

window.toggleCore = function(i) {
  const row = document.querySelector(`.cart-item[data-index="${i}"]`);
  if (!row) return;
  
  const coreEl = row.querySelector('.cart-item-core');
  const exp = row.querySelector('.cart-item-expand');
  const open = coreEl.style.display === 'block';
  coreEl.style.display = open ? 'none' : 'block';
  exp.classList.toggle('open', !open);
};

window.updateQty = function(i, val) {
  let cart = window.loadCart();
  let q = parseInt(val); 
  if (isNaN(q) || q < 1) q = 1;
  if (cart[i]) cart[i].quantity = q;
  window.saveCart(cart);
  window.renderCart();
};

window.removeItem = function(i) {
  let cart = window.loadCart();
  cart.splice(i, 1);
  window.saveCart(cart);
  window.renderCart();
};

window.saveAndToast = function() { 
  alert('Cart quantities updated!'); 
};

window.goHomePage = function() { 
  window.location.href = 'index.html'; 
};

// Form validation functions
function validateForm() {
  let isValid = true;
  let missingFields = [];
  
  // Reset errors
  document.querySelectorAll('.form-error').forEach(el => el.style.display = 'none');
  document.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
  
  // Validate required fields
  if (!$customerEmail.value.trim()) {
    document.getElementById('email-error').style.display = 'block';
    $customerEmail.classList.add('invalid');
    isValid = false;
    missingFields.push('Email Address');
  }
  
  if (!$customerPhone.value.trim()) {
    document.getElementById('phone-error').style.display = 'block';
    $customerPhone.classList.add('invalid');
    isValid = false;
    missingFields.push('Phone Number');
  }
  
  if (!$customerName.value.trim()) {
    document.getElementById('name-error').style.display = 'block';
    $customerName.classList.add('invalid');
    isValid = false;
    missingFields.push('Full Name');
  }
  
  if (!$customerAddress1.value.trim()) {
    document.getElementById('address1-error').style.display = 'block';
    $customerAddress1.classList.add('invalid');
    isValid = false;
    missingFields.push('Address Line 1');
  }
  
  if (!$customerCity.value.trim()) {
    document.getElementById('city-error').style.display = 'block';
    $customerCity.classList.add('invalid');
    isValid = false;
    missingFields.push('City');
  }
  
  if (!$customerState.value.trim()) {
    document.getElementById('state-error').style.display = 'block';
    $customerState.classList.add('invalid');
    isValid = false;
    missingFields.push('State/Province/Region');
  }
  
  if (!$customerZip.value.trim()) {
    document.getElementById('zip-error').style.display = 'block';
    $customerZip.classList.add('invalid');
    isValid = false;
    missingFields.push('ZIP/Postal Code');
  }
  
  if (!$customerCountry.value) {
    document.getElementById('country-error').style.display = 'block';
    $customerCountry.classList.add('invalid');
    isValid = false;
    missingFields.push('Country');
  }
  
  if (!isValid) {
    showValidationPopup("Please fill in the following required fields:\n\n• " + missingFields.join("\n• "));
    return false;
  }
  
  return true;
}

// Add input event listeners to clear validation errors
[$customerEmail, $customerPhone, $customerName, $customerAddress1, $customerCity, $customerState, $customerZip, $customerCountry].forEach(input => {
  input.addEventListener('input', function() {
    this.classList.remove('invalid');
    const errorId = this.id + '-error';
    if (document.getElementById(errorId)) {
      document.getElementById(errorId).style.display = 'none';
    }
  });
});

// Prefill
(function(){
  try {
    const v = JSON.parse(localStorage.getItem('lf_customer_info') || 'null'); 
    if (!v) return;
    $customerEmail.value = v.email || ""; 
    $customerPhone.value = v.phone || ""; 
    $customerCompany.value = v.company || "";
    $customerName.value = v.name || ""; 
    $customerAddress1.value = v.address1 || ""; 
    $customerAddress2.value = v.address2 || "";
    $customerCity.value = v.city || ""; 
    $customerState.value = v.state || ""; 
    $customerZip.value = v.zip || "";
    $customerCountry.value = v.country || "US"; 
    $customerInstructions.value = v.instructions || "";
    $engineModel.value = v.engineModel || "";
    $engineSerial.value = v.engineSerial || "";
  } catch(_) {}
})();

// NEW: update note immediately when user changes selection
$paymentMethod.addEventListener('change', window.setPaymentNote);

window.checkout = async function() {
  const cart = window.loadCart(); 
  if (cart.length === 0) { 
    showError('Your cart is empty.'); 
    return; 
  }
  
  const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test($customerEmail.value.trim());
  if (!emailOk) { 
    showError('Please enter a valid email.'); 
    $customerEmail.focus(); 
    return; 
  }

  const pm = $paymentMethod.value;
  if (!pm) {
    showError('Please select a payment method.');
    $paymentMethod.focus();
    return;
  }

  if (!validateForm()) {
    return;
  }

  try {
    setLoading(true);
    
    let subtotal = 0;
    let coreTotal = 0;
    
    cart.forEach(item => {
      const qty = Math.max(1, parseInt(item.quantity || 1));
      const price = Number(item.price) || 0;
      const core = Number(item.core_charge) || 0;
      subtotal += qty * price; 
      coreTotal += qty * core;
    });

    const orderData = {
  totals: {
    subtotal: subtotal,
    coreTotal: coreTotal
  },
  customer: {
    email: $customerEmail.value.trim(),
    phone: $customerPhone.value.trim(),
    company: $customerCompany.value.trim(),
    name: $customerName.value.trim(),
    address1: $customerAddress1.value.trim(),
    address2: $customerAddress2.value.trim(),
    city: $customerCity.value.trim(),
    state: $customerState.value.trim(),
    zip: $customerZip.value.trim(),
    country: $customerCountry.value,
    instructions: $customerInstructions.value.trim(),
    engineModel: $engineModel.value.trim(),
    engineSerial: $engineSerial.value.trim()
  },
  payment: {
    method: pm,
    note: getPaymentNoteText(pm)
  },
  // ↓ keep payload small for big carts
  items: cart.map(it => ({
    part_number: it.part_number || it.name || "",
    description: it.description || "",
    quantity: Math.max(1, parseInt(it.quantity || 1)),
    price: Number(it.price) || 0,
    core_charge: Number(it.core_charge) || 0,
    currency: it.currency || "USD"
  }))
};

    // Send to backend
    const response = await fetch('https://lf-cart-api.pages.dev/api/checkout', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(orderData)
    });
    
    const raw = await response.text();
let data;
try { data = JSON.parse(raw); } catch { data = null; }

if (!response.ok) {
  const serverMsg = (data && (data.error || data.message)) || raw || `Server error: ${response.status}`;
  throw new Error(serverMsg);
}

    
	
    if (!data || !data.emailData) {
    // Fallback: create email content manually
    const emailSubject = `Order from ${orderData.customer.name}`;
    let emailBody = `Order Details:\n\n`;
    emailBody += `Customer: ${orderData.customer.name}\n`;
    emailBody += `Email: ${orderData.customer.email}\n`;
    emailBody += `Phone: ${orderData.customer.phone}\n`;
    if (orderData.customer.company) emailBody += `Company: ${orderData.customer.company}\n`;
    emailBody += `Address: ${orderData.customer.address1}\n`;
    if (orderData.customer.address2) emailBody += `Address 2: ${orderData.customer.address2}\n`;
    emailBody += `City: ${orderData.customer.city}\n`;
    emailBody += `State/Region: ${orderData.customer.state}\n`;
    emailBody += `ZIP/Postal: ${orderData.customer.zip}\n`;
    emailBody += `Country: ${orderData.customer.country}\n`;
    if (orderData.customer.engineModel) emailBody += `Engine Model: ${orderData.customer.engineModel}\n`;
    if (orderData.customer.engineSerial) emailBody += `Engine Serial: ${orderData.customer.engineSerial}\n`;
    if (orderData.customer.instructions) emailBody += `Special Instructions: ${orderData.customer.instructions}\n`;
    emailBody += `Payment Method: ${$paymentMethod.options[$paymentMethod.selectedIndex].text}\n`;
    emailBody += `Payment Note: ${orderData.payment.note}\n\n`;
    
    emailBody += `Total: $${orderData.totals.subtotal}\n`;
    if (orderData.totals.coreTotal > 0) emailBody += `Core: $${orderData.totals.coreTotal}\n\n`;
    
    emailBody += `Items:\n`;
    orderData.items.forEach(item => {
        emailBody += `- ${item.quantity}x ${item.part_number} - $${item.price}\n`;
        if (item.description) emailBody += `  Description: ${item.description}\n`;
        if (item.core_charge > 0) emailBody += `  Core Charge: $${item.core_charge} each\n`;
    });
    
    // If mailto is too long, download CSV and send a short email
const tentative = makeMailtoLink(emailSubject, emailBody);
if (tentative.length > 1800) {
  // Generate a unique order ID
const orderId = Date.now();  // Generates a unique order ID based on the current timestamp

// Trigger the CSV download (ensure this happens first)
const fname = downloadOrderFile(orderData, orderId);  // This triggers the CSV download

// Send the order data to the server without blocking the download
try {
  const payload = new Blob([JSON.stringify(orderData)], { type: 'application/json' });  // Convert order data into JSON
  if (navigator.sendBeacon) {
    navigator.sendBeacon('https://lf-cart-api.pages.dev/api/checkout', payload);  // Send data asynchronously
  } else {
    // Fallback to fetch if sendBeacon is not available (non-blocking)
    fetch('https://lf-cart-api.pages.dev/api/checkout', { 
      method: 'POST', 
      headers: { 'Content-Type': 'application/json' }, 
      body: JSON.stringify(orderData) 
    }).catch(() => {});
  }
} catch (_) {}

// Now, ensure the file can be seen by the user before opening the mail client:
if (typeof navigator !== "undefined" && navigator.canShare && window.File) {
  try {
    const file = new File([new Blob([fname], { type: 'text/csv' })], fname, { type: 'text/csv' });
    
    if (navigator.canShare({ files: [file] })) {
      navigator.share({
        files: [file],
        title: fname,
        text: "Order CSV attached."
      }).catch((err) => {
        console.error("Error sharing file:", err);
      });
    }
  } catch (err) {
    console.error("Error while preparing file for sharing:", err);
  }
}

  const shortBody =
    `Large order details saved as file: ${fname}\n\n` +
  `Please attach the downloaded file and send.\n\n` +
  `Customer: ${orderData.customer.name}\n` +
  `Email: ${orderData.customer.email}\n` +
  `Phone: ${orderData.customer.phone || "N/A"}\n` +
  `Company: ${orderData.customer.company || "N/A"}\n` +
  `Shipping Address: ${orderData.customer.address1}, ${orderData.customer.city}, ${orderData.customer.state}, ${orderData.customer.zip}, ${orderData.customer.country}\n` +
  `Payment Method: ${orderData.payment.method}\n` +
  `Payment Note: ${orderData.payment.note}\n` +
  `Special Instructions: ${orderData.customer.instructions || "None"}\n\n` +
  (orderData.totals
     ? `Subtotal: $${orderData.totals.subtotal}\nCore: $${orderData.totals.coreTotal}\n\n`
     : ``) +
  `---\n(Generated by Part Finder checkout)`;
  openMailSafely(makeMailtoLink(emailSubject, shortBody));
} else {
  openMailSafely(tentative);
}

    // Works even when embedded (Durable iframe)

} else {
    const sub = data.emailData.subject;
const bod = data.emailData.body;
const tentative2 = makeMailtoLink(sub, bod);
if (tentative2.length > 1800) {
  // Generate a unique order ID
const orderId = Date.now();  // Generates a unique order ID based on the current timestamp

// Trigger the CSV download (ensure this happens first)
const fname = downloadOrderFile(orderData, orderId);  // This triggers the CSV download

// Send the order data to the server without blocking the download
try {
  const payload = new Blob([JSON.stringify(orderData)], { type: 'application/json' });  // Convert order data into JSON
  if (navigator.sendBeacon) {
    navigator.sendBeacon('https://lf-cart-api.pages.dev/api/checkout', payload);  // Send data asynchronously
  } else {
    // Fallback to fetch if sendBeacon is not available (non-blocking)
    fetch('https://lf-cart-api.pages.dev/api/checkout', { 
      method: 'POST', 
      headers: { 'Content-Type': 'application/json' }, 
      body: JSON.stringify(orderData) 
    }).catch(() => {});
  }
} catch (_) {}

// Now, ensure the file can be seen by the user before opening the mail client:
if (typeof navigator !== "undefined" && navigator.canShare && window.File) {
  try {
    const file = new File([new Blob([fname], { type: 'text/csv' })], fname, { type: 'text/csv' });
    
    if (navigator.canShare({ files: [file] })) {
      navigator.share({
        files: [file],
        title: fname,
        text: "Order CSV attached."
      }).catch((err) => {
        console.error("Error sharing file:", err);
      });
    }
  } catch (err) {
    console.error("Error while preparing file for sharing:", err);
  }
}


	const shortBody =
     `Large order details saved as file: ${fname}\n\n` +
  `Please attach the downloaded file and send.\n\n` +
  `Customer: ${orderData.customer.name}\n` +
  `Email: ${orderData.customer.email}\n` +
  `Phone: ${orderData.customer.phone || "N/A"}\n` +
  `Company: ${orderData.customer.company || "N/A"}\n` +
  `Shipping Address: ${orderData.customer.address1}, ${orderData.customer.city}, ${orderData.customer.state}, ${orderData.customer.zip}, ${orderData.customer.country}\n` +
  `Payment Method: ${orderData.payment.method}\n` +
  `Payment Note: ${orderData.payment.note}\n` +
  `Special Instructions: ${orderData.customer.instructions || "None"}\n\n` +
  (orderData.totals
     ? `Subtotal: $${orderData.totals.subtotal}\nCore: $${orderData.totals.coreTotal}\n\n`
     : ``) +
  `---\n(Generated by Part Finder checkout)`;
  openMailSafely(makeMailtoLink(sub, shortBody));
} else {
  openMailSafely(tentative2);
}

    // Works even when embedded (Durable iframe)

}
    
    showSuccess('Email client opened! Please send the email to complete your order.');
    
    // Clear cart after email is sent
    setTimeout(() => {
      window.saveCart([]);
      window.renderCart();
    }, 3000);
    
  } catch (error) {
    console.error('Checkout error:', error);
    showError('Failed to submit order: ' + error.message);
  } finally {
    setLoading(false);
  }
};

// Initial render
window.renderCart();
// NEW: if a method is already selected (e.g., browser autofill), reflect its note
window.setPaymentNote();

// Fix for the "goHomePage is not defined" error
document.getElementById('home-button').addEventListener('click', window.goHomePage);

// Fix for the "checkout is not defined" error
document.getElementById('checkout-button').addEventListener('click', function() {
  window.checkout();
});

// Fix for the "update-cart-button" error
document.getElementById('update-cart-button').addEventListener('click', window.saveAndToast);

// Close popup when clicking outside
$validationPopup.addEventListener('click', function(e) {
  if (e.target === $validationPopup) {
    hideValidationPopup();
  }
});

document.getElementById('popup-close-btn').addEventListener('click', hideValidationPopup);
</script>
</body>
</html>
