<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Cart - Part Finder</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
body{background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);color:#2d3748;line-height:1.6;min-height:100vh}
.container{max-width:1200px;margin:0 auto;padding:20px}

/* Header */
.header{ text-align:center; margin-bottom:30px; padding:30px 20px; background:linear-gradient(120deg,#2c3e50 0%,#3498db 100%); color:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.15); position:relative;}
.header h1{ font-size:2.8rem; margin-bottom:10px; font-weight:700;}
.header p{ font-size:1.2rem; opacity:.9; max-width:700px; margin:0 auto;}
.cart-icon-header{ position:absolute; top:20px; right:20px; cursor:pointer; font-size:24px; color:white; display:flex; align-items:center; gap:8px;}
.core-badge-header{ position:absolute; top:50px; right:20px; background:#f39c12; color:white; padding:4px 8px; border-radius:12px; font-size:12px; font-weight:600; display:none; }

/* Navigation */
.nav-back{ margin-bottom:20px;}
.back-btn{ padding:12px 24px; background:#2c3e50; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:500; display:inline-flex; align-items:center; gap:8px; transition:.3s; text-decoration:none;}
.back-btn:hover{ background:#1a202c; }

/* Cart */
.cart-content{ background:white; border-radius:16px; padding:25px; box-shadow:0 5px 20px rgba(0,0,0,.08);}
.cart-items{ margin-bottom:25px;}
.cart-item{ border:1px solid #e2e8f0; border-radius:12px; margin-bottom:15px; overflow:hidden;}
.cart-item-main{ display:flex; justify-content:space-between; padding:18px; align-items:center; background:#f8f9fa; cursor:pointer;}
.cart-item-details{ flex:1;}
.cart-item-name{ font-weight:600; margin-bottom:6px; color:#2c3e50; display:flex; align-items:center; gap:10px;}
.cart-item-description{ color:#718096; font-size:14px; margin-bottom:8px; font-style:italic;}
.cart-item-core-badge{ background:#f39c12; color:white; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:600;}
.cart-item-price{ color:#718096; font-size:14px; }
.cart-item-expand{ color:#718096; font-size:14px; transition:.3s;}
.cart-item-expand.open{ transform:rotate(180deg);}
.cart-item-core{ padding:15px; background:#fff5f5; border-top:1px solid #fed7d7; display:none;}
.cart-item-core-content{ display:flex; justify-content:space-between; align-items:center;}
.cart-item-core-info{ flex:1;}
.cart-item-core-name{ font-weight:500; margin-bottom:4px; color:#c53030;}
.cart-item-core-desc{ color:#e53e3e; font-size:13px;}
.cart-item-remove{ color:#e53e3e; background:none; border:none; cursor:pointer; padding:8px 16px; font-size:14px; border-radius:6px; transition:.3s;}
.cart-item-remove:hover{ background:#fed7d7;}
.cart-total{ font-weight:700; text-align:right; padding:20px 0; border-top:2px solid #e2e8f0; font-size:20px; color:#2c3e50;}

/* Update Cart Button */
.update-cart-btn{ padding:12px 20px; background:#2c3e50; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:500; margin-bottom:20px; display:flex; align-items:center; gap:8px; transition:.3s;}
.update-cart-btn:hover{ background:#1a202c; }

/* Customer Info + Checkout */
.customer-info-section{ background:#f8f9fa; border-radius:12px; padding:20px; margin-bottom:20px;}
.customer-info-title{ font-size:20px; color:#2c3e50; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #e2e8f0;}
.customer-form{ display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:15px;}
.form-group{ margin-bottom:15px;}
.form-label{ display:block; margin-bottom:6px; font-weight:500; color:#4a5568;}
.form-input,.form-textarea,.form-select{ width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; transition:border-color .3s;}
.form-textarea{ min-height:80px; resize:vertical;}
.form-required::after{ content:"*"; color:#e53e3e; margin-left:4px;}
.form-error{ color:#e53e3e; font-size:14px; margin-top:5px; display:none;}
.invalid{ border-color:#e53e3e !important; box-shadow:0 0 0 3px rgba(229,62,62,.15) !important; }

/* Checkout */
.checkout-section{ background:#f8f9fa; border-radius:12px; padding:20px; margin-top:20px;}
.checkout-title{ font-size:20px; color:#2c3e50; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #e2e8f0;}
.checkout-instructions{ margin-bottom:15px; color:#4a5568; line-height:1.5;}
.payment-method{ margin-bottom:15px;}
.payment-label{ display:block; margin-bottom:6px; font-weight:500; color:#4a5568;}
.payment-select{ width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; margin-bottom:8px;}
.payment-note{ color:#718096; font-size:14px; font-style:italic;}
.shipping-note{ margin-bottom:15px; padding:12px; background:#ebf8ff; border-radius:8px; color:#2b6cb0; border-left:4px solid #4299e1;}
.compliance-notes{ margin-bottom:20px;}
.compliance-note{ color:#718096; font-size:14px; margin-bottom:8px; padding-left:15px; position:relative;}
.compliance-note:before{ content:"•"; position:absolute; left:0;}
.checkout-btn{ padding:15px 30px; background:linear-gradient(120deg,#2980b9 0%,#3498db 100%); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; font-size:16px; width:100%; transition:.3s; display:flex; align-items:center; justify-content:center; gap:10px;}
.checkout-btn:hover{ transform:translateY(-2px); box-shadow:0 6px 12px rgba(52,152,219,.4);}
.checkout-helper{ margin-top:10px; text-align:center; color:#718096; font-size:14px;}

/* Responsive */
@media (max-width:768px){
  .header h1{ font-size:2.2rem;}
  .header p{ font-size:1rem;}
  .cart-item-main{ flex-direction:column; align-items:flex-start; gap:10px;}
  .cart-icon-header{ position:relative; top:0; right:0; margin-top:15px; justify-content:center;}
  .core-badge-header{ position:relative; top:0; right:0; margin:5px auto; width:fit-content;}
  .customer-form{ grid-template-columns:1fr;}
}

@keyframes fadeIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
.loading{ display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:#fff; animation:spin 1s ease-in-out infinite;}
@keyframes spin{ to{ transform:rotate(360deg);} }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1><i class="fas fa-shopping-cart"></i> Your Cart</h1>
    <p>Review your items and proceed to checkout</p>
    <div class="cart-icon-header" onclick="goHomePage()">
      <i class="fas fa-home"></i> Back to Search
    </div>
    <div class="core-badge-header" id="core-badge-header">
      <i class="fas fa-exclamation-circle"></i> Core Items
    </div>
  </div>

  <div class="nav-back">
    <a class="back-btn" href="index.html"><i class="fas fa-arrow-left"></i> Back to Search</a>
  </div>

  <div class="cart-content">
    <button class="update-cart-btn" onclick="saveAndToast()"><i class="fas fa-sync-alt"></i> Update Cart Quantities</button>
    <div class="cart-items" id="cart-items">
      <div class="empty-cart"><i class="fas fa-shopping-cart"></i><br/> Your cart is empty</div>
    </div>
    <div class="cart-total" id="cart-total">Total: $0.00</div>

    <!-- Customer Information -->
    <div class="customer-info-section">
      <div class="customer-info-title">Customer Information</div>
      <div class="customer-form">
        <div class="form-group">
          <label class="form-label form-required" for="customer-email">Email Address</label>
          <input class="form-input" id="customer-email" placeholder="your.email@example.com" type="email"/>
          <div class="form-error" id="email-error">Please enter a valid email address</div>
        </div>
        <div class="form-group">
          <label class="form-label form-required" for="customer-phone">Phone Number</label>
          <input class="form-input" id="customer-phone" placeholder="+1 470 608 3818" type="tel"/>
          <div class="form-error" id="phone-error">Please enter a valid phone number</div>
        </div>
        <div class="form-group">
          <label class="form-label" for="customer-company">Company Name</label>
          <input class="form-input" id="customer-company" placeholder="Your Company Name" type="text"/>
        </div>

        <!-- NEW: Engine Model (Optional) -->
        <div class="form-group"> <!-- NEW -->
          <label class="form-label" for="engine-model">Engine Model (Optional)</label> <!-- NEW -->
          <input class="form-input" id="engine-model" placeholder="e.g., Cummins ISX15, CAT 3406E" type="text"/> <!-- NEW -->
        </div> <!-- NEW -->

        <div class="form-group">
          <label class="form-label form-required" for="customer-name">Full Name</label>
          <input class="form-input" id="customer-name" placeholder="First and Last Name" type="text"/>
          <div class="form-error" id="name-error">Please enter your name</div>
        </div>

        <!-- NEW: Engine Serial Number (Optional) -->
        <div class="form-group"> <!-- NEW -->
          <label class="form-label" for="engine-serial">Engine Serial Number (Optional)</label> <!-- NEW -->
          <input class="form-input" id="engine-serial" placeholder="e.g., S/N 79312345" type="text"/> <!-- NEW -->
        </div> <!-- NEW -->

        <div class="form-group">
          <label class="form-label form-required" for="customer-address1">Address Line 1</label>
          <input class="form-input" id="customer-address1" placeholder="Street address, P.O. box" type="text"/>
          <div class="form-error" id="address1-error">Please enter your address</div>
        </div>
        <div class="form-group">
          <label class="form-label" for="customer-address2">Address Line 2</label>
          <input class="form-input" id="customer-address2" placeholder="Apartment, suite, unit, building, floor, etc." type="text"/>
        </div>
        <div class="form-group">
          <label class="form-label form-required" for="customer-city">City</label>
          <input class="form-input" id="customer-city" placeholder="City" type="text"/>
          <div class="form-error" id="city-error">Please enter your city</div>
        </div>
        <div class="form-group">
          <label class="form-label form-required" for="customer-state">State/Province/Region</label>
          <input class="form-input" id="customer-state" placeholder="State / Province / Region" type="text"/>
          <div class="form-error" id="state-error">Please enter your state/province</div>
        </div>
        <div class="form-group">
          <label class="form-label form-required" for="customer-zip">ZIP/Postal Code</label>
          <input class="form-input" id="customer-zip" placeholder="ZIP / Postal code" type="text"/>
          <div class="form-error" id="zip-error">Please enter your ZIP/postal code</div>
        </div>
        <div class="form-group">
          <label class="form-label form-required" for="customer-country">Country</label>
          <select class="form-select" id="customer-country">
            <option value="">Select Country</option>
            <option selected value="US">United States</option>
            <option value="CA">Canada</option>
            <option value="MX">Mexico</option>
            <option value="AU">Australia</option>
            <option value="GB">United Kingdom</option>
            <option value="DE">Germany</option>
            <option value="FR">France</option>
            <option value="OTHER">Other</option>
          </select>
          <div class="form-error" id="country-error">Please select your country</div>
        </div>
        <div class="form-group" style="grid-column:1 / -1;">
          <label class="form-label" for="customer-instructions">Special Instructions</label>
          <textarea class="form-textarea" id="customer-instructions" placeholder="Any special shipping instructions or notes about your order"></textarea>
        </div>
      </div>
    </div>

    <div class="checkout-section">
      <div class="checkout-title">How Checkout Works</div>
      <div class="checkout-instructions">
        The Proceed to Checkout button does not process payment—it sends your order details to Limitless so we can confirm availability, shipping, and send you a secure payment link.
      </div>
      <div class="payment-method">
        <label class="payment-label" for="payment-method">Choose your preferred payment method:</label>
        <select class="payment-select" id="payment-method">
          <option value="">Select a payment method</option>
          <option value="credit_card">Credit Card (Visa/Mastercard/AmEx)</option>
          <option value="paypal">PayPal</option>
          <option value="bank_wire">Bank Wire</option>
          <option value="zelle">Zelle</option>
          <option value="ach">ACH (U.S. only)</option>
        </select>
        <div class="payment-note" id="payment-note"></div>
      </div>
      <div class="shipping-note">
        <strong>Shipping &amp; Handling:</strong> Calculated after we confirm weight, dimensions, and destination. You'll see the final S&amp;H on our reply email with your payment link.
      </div>
      <div class="compliance-notes">
        <div class="compliance-note"> Stock &amp; Lead Time: Availability and lead times are confirmed by email before payment.</div>
        <div class="compliance-note"> Tax: Sales tax, if applicable, is shown on your final invoice (or buyer may owe use tax).</div>
        <div class="compliance-note"> International: Duties and import charges are paid by the consignee unless otherwise agreed.</div>
      </div>
      <button class="checkout-btn" onclick="checkout()"><i class="fas fa-paper-plane"></i> Proceed to Checkout</button>
      <div class="checkout-helper">This will email your order details to Limitless; you'll get a confirmation and payment link.</div>
    </div>
  </div>
</div>

<script>
const CURRENCY_FALLBACK="USD", DECIMALS=2;
const $cartItems=document.getElementById('cart-items');
const $cartTotal=document.getElementById('cart-total');
const $coreBadgeHeader=document.getElementById('core-badge-header');

const $paymentMethod=document.getElementById('payment-method');
const $paymentNote=document.getElementById('payment-note');

const $customerEmail=document.getElementById('customer-email');
const $customerPhone=document.getElementById('customer-phone');
const $customerCompany=document.getElementById('customer-company');
const $customerName=document.getElementById('customer-name');
const $customerAddress1=document.getElementById('customer-address1');
const $customerAddress2=document.getElementById('customer-address2');
const $customerCity=document.getElementById('customer-city');
const $customerState=document.getElementById('customer-state');
const $customerZip=document.getElementById('customer-zip');
const $customerCountry=document.getElementById('customer-country');
const $customerInstructions=document.getElementById('customer-instructions');

// NEW: Engine fields
const $engineModel=document.getElementById('engine-model');   // NEW
const $engineSerial=document.getElementById('engine-serial'); // NEW

const fmtMoney=(num,cur)=>{ const n=Number(num); if(!isFinite(n))return String(num||""); return `${cur||CURRENCY_FALLBACK} ${n.toFixed(DECIMALS)}`; };
const esc=s=>(s??'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

// NEW: show payment note text based on selection
function setPaymentNote(){
  const v = $paymentMethod.value;
  let text = '';
  if (v === 'credit_card') text = 'Card payments incur +3.5% + $0.30 processing.';
  else if (v === 'paypal') text = 'PayPal payments incur +3.9% + $0.30 processing. We’ll send a PayPal link.';
  else if (v === 'bank_wire') text = 'Bank wire transfers incur a $25 bank fee. We’ll email you our banking details.';
  else if (v === 'zelle') text = 'No processing fee. We’ll email the Zelle instructions.';
  else if (v === 'ach') text = 'No processing fee. We’ll email the ACH instructions.';
  $paymentNote.textContent = text;
}

function loadCart(){ try{ return JSON.parse(localStorage.getItem('lf_cart')||'[]'); }catch(_){ return []; } }
function saveCart(cart){ try{ localStorage.setItem('lf_cart', JSON.stringify(cart)); }catch(_){} }

function renderCart(){
  const cart=loadCart();
  if(cart.length===0){
    $cartItems.innerHTML='<div class="empty-cart"><i class="fas fa-shopping-cart"></i><br/> Your cart is empty</div>';
    $cartTotal.textContent='Total: $0.00';
    $coreBadgeHeader.style.display='none';
    return;
  }
  let html='', subtotal=0, coreTotal=0, hasCore=false;
  cart.forEach((item,i)=>{
    const qty=Math.max(1,parseInt(item.quantity||1));
    const price=Number(item.price)||0;
    const core=Number(item.core_charge)||0;
    subtotal+=qty*price; coreTotal+=qty*core; if(core>0) hasCore=true;
    html+=`
      <div class="cart-item" data-index="${i}">
        <div class="cart-item-main" onclick="toggleCore(${i})">
          <div class="cart-item-details">
            <div class="cart-item-name">${esc(item.part_number||item.name||'Item')} ${core>0?'<span class="cart-item-core-badge">CORE</span>':''}</div>
            <div class="cart-item-description">${esc(item.description||'')}</div>
            <div class="cart-item-price">
              ${fmtMoney(price,item.currency)} × 
              <input type="number" min="1" value="${qty}" style="width:60px;padding:4px;border:1px solid #ddd;border-radius:4px" onchange="updateQty(${i},this.value)">
              = ${fmtMoney(qty*price,item.currency)}
            </div>
          </div>
          <div class="cart-item-expand"><i class="fas fa-chevron-down"></i></div>
        </div>
        ${core>0?`
          <div class="cart-item-core" style="display:none;">
            <div class="cart-item-core-content">
              <div class="cart-item-core-info">
                <div class="cart-item-core-name">Core Charge: ${fmtMoney(core,item.currency)} × ${qty}</div>
                <div class="cart-item-core-desc">Refundable on eligible core return.</div>
              </div>
              <button class="cart-item-remove" onclick="removeItem(${i})"><i class="fas fa-trash"></i> Remove</button>
            </div>
          </div>`:
          `<div class="cart-item-core" style="display:none;">
             <div class="cart-item-core-content">
               <div class="cart-item-core-info"></div>
               <button class="cart-item-remove" onclick="removeItem(${i})"><i class="fas fa-trash"></i> Remove</button>
             </div>
           </div>`}
      </div>`;
  });
  $cartItems.innerHTML=html;
  $cartTotal.textContent=`Total: ${fmtMoney(subtotal,'USD')}${hasCore?` + Core: ${fmtMoney(coreTotal,'USD')}`:''}`;
  $coreBadgeHeader.style.display=hasCore?'flex':'none';
}

function toggleCore(i){
  const row=document.querySelector(`.cart-item[data-index="${i}"]`);
  const coreEl=row.querySelector('.cart-item-core');
  const exp=row.querySelector('.cart-item-expand');
  const open=coreEl.style.display==='block';
  coreEl.style.display=open?'none':'block';
  exp.classList.toggle('open',!open);
}

function updateQty(i,val){
  let cart=loadCart();
  let q=parseInt(val); if(isNaN(q)||q<1) q=1;
  if(cart[i]) cart[i].quantity=q;
  saveCart(cart);
  renderCart();
}

function removeItem(i){
  let cart=loadCart();
  cart.splice(i,1);
  saveCart(cart);
  renderCart();
}

function saveAndToast(){ alert('Cart quantities updated!'); }
function goHomePage(){ window.location.href='index.html'; }

// Prefill
(function(){
  try{
    const v=JSON.parse(localStorage.getItem('lf_customer_info')||'null'); if(!v) return;
    $customerEmail.value=v.email||""; $customerPhone.value=v.phone||""; $customerCompany.value=v.company||"";
    $customerName.value=v.name||""; $customerAddress1.value=v.address1||""; $customerAddress2.value=v.address2||"";
    $customerCity.value=v.city||""; $customerState.value=v.state||""; $customerZip.value=v.zip||"";
    $customerCountry.value=v.country||"US"; $customerInstructions.value=v.instructions||"";
    // NEW: prefill engine fields if present
    if (v.engine_model) $engineModel.value = v.engine_model;      // NEW
    if (v.engine_serial) $engineSerial.value = v.engine_serial;    // NEW
  }catch(_){}
})();

// Payment note change
$paymentMethod.addEventListener('change', setPaymentNote);

// Helpers for ASCII table formatting (email body)
function pad(str, width){ // NEW
  str = (str==null?'':String(str));
  if (str.length > width) return str.slice(0, width-1) + '…';
  return str + ' '.repeat(width - str.length);
} // NEW

<script>
// ...keep everything above as-is

function checkout(){
  const cart=loadCart(); if(cart.length===0){ alert('Your cart is empty.'); return; }
  const emailOk=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test($customerEmail.value.trim());
  if(!emailOk){ alert('Please enter a valid email.'); $customerEmail.focus(); return; }

  const pm = $paymentMethod.value;
  if(!pm){ alert('Please select a payment method.'); $paymentMethod.focus(); return; }

  const subject = encodeURIComponent(`Order Request: ${cart.length} items`);
  const MAILTO_LIMIT = 1800; // conservative cross-browser limit

  // helpers scoped to this function (no globals added)
  const makeMailto = (body) => `mailto:info@limitless-llc.us?subject=${subject}&body=${encodeURIComponent(body)}`;

  const partLine = (lbl,val) => `${lbl}: ${val}\n`;

  const buildAsciiTable = () => {
    const COLS = { PART:15, DESC:40, QTY:5, PRICE:12, CORE:12, LINE:12 };
    const pad = (str, width) => {
      str = (str==null?'':String(str));
      if (str.length > width) return str.slice(0, width-1) + '…';
      return str + ' '.repeat(width - str.length);
    };

    let subtotal=0, coreTotal=0, lines=[];
    lines.push(
      pad('Part',COLS.PART)+pad('Description',COLS.DESC)+pad('Qty',COLS.QTY)+
      pad('Unit Price',COLS.PRICE)+pad('Core',COLS.CORE)+pad('Line Total',COLS.LINE)
    );
    lines.push('-'.repeat(COLS.PART+COLS.DESC+COLS.QTY+COLS.PRICE+COLS.CORE+COLS.LINE));

    cart.forEach(item=>{
      const qty=Math.max(1,parseInt(item.quantity||1));
      const price=Number(item.price)||0;
      const core=Number(item.core_charge)||0;
      const lineTotal=qty*price; subtotal+=lineTotal; coreTotal+=qty*core;
      const part = item.part_number || item.name || '';
      const desc = (item.description||'').replace(/\s+/g,' ').trim();
      lines.push(
        pad(part,COLS.PART)+
        pad(desc,COLS.DESC)+
        pad(String(qty),COLS.QTY)+
        pad(fmtMoney(price,item.currency),COLS.PRICE)+
        pad(core>0?fmtMoney(core,item.currency):'-',COLS.CORE)+
        pad(fmtMoney(lineTotal,item.currency),COLS.LINE)
      );
    });

    return {
      table: lines.join('\n'),
      subtotal, coreTotal
    };
  };

  const buildCompactItems = (cart, subtotal, coreTotal) => {
    let s = 'Items (compact):\nPart|Qty|Unit|Core|Line\n';
    cart.forEach(item=>{
      const qty=Math.max(1,parseInt(item.quantity||1));
      const price=Number(item.price)||0;
      const core=Number(item.core_charge)||0;
      const lineTotal=qty*price;
      const pn = item.part_number || item.name || '';
      s += `${pn}|${qty}|${fmtMoney(price,item.currency)}|${core>0?fmtMoney(core,item.currency):'-'}|${fmtMoney(lineTotal,item.currency)}\n`;
    });
    s += `\nSubtotal (parts): ${fmtMoney(subtotal,'USD')}\n`;
    if (coreTotal>0) s += `Core Total: ${fmtMoney(coreTotal,'USD')}\n`;
    s += `(Descriptions omitted to fit email size)\n`;
    return s;
  };

  // build items block (ASCII table)
  const {table, subtotal, coreTotal} = buildAsciiTable();
  let itemsBlock = `Order Details (Items):\n\n${table}\n\nSubtotal (parts): ${fmtMoney(subtotal,'USD')}\n`;
  if (coreTotal>0) itemsBlock += `Core Total: ${fmtMoney(coreTotal,'USD')}\n`;

  // customer block
  let customerBlock = `\nCustomer Information:\n`;
  customerBlock += partLine('Name', $customerName.value);
  customerBlock += partLine('Email', $customerEmail.value);
  customerBlock += partLine('Phone', $customerPhone.value);
  if ($customerCompany.value) customerBlock += partLine('Company', $customerCompany.value);

  // optional engine fields preserved
  if (document.getElementById('engine-model')?.value) customerBlock += partLine('Engine Model', document.getElementById('engine-model').value);
  if (document.getElementById('engine-serial')?.value) customerBlock += partLine('Engine Serial Number', document.getElementById('engine-serial').value);

  customerBlock += partLine('Address', $customerAddress1.value);
  if ($customerAddress2.value) customerBlock += partLine('Address 2', $customerAddress2.value);
  customerBlock += partLine('City', $customerCity.value);
  customerBlock += partLine('State', $customerState.value);
  customerBlock += partLine('ZIP', $customerZip.value);
  customerBlock += partLine('Country', $customerCountry.value);
  if ($customerInstructions.value) customerBlock += partLine('Instructions', $customerInstructions.value);

  // payment block
  let paymentBlock = `\nPayment Method: ${pm}\n`;
  if ($paymentNote.textContent) paymentBlock += `Payment Note: ${$paymentNote.textContent}\n`;

  // compose full body
  let body = itemsBlock + customerBlock + '\n' + paymentBlock;

  // if mailto url too long, use compact items and/or truncate
  let href = makeMailto(body);
  if (href.length > MAILTO_LIMIT) {
    const compact = buildCompactItems(cart, subtotal, coreTotal);
    body = compact + '\n' + customerBlock + '\n' + paymentBlock;
    href = makeMailto(body);

    if (href.length > MAILTO_LIMIT) {
      // truncate compact items lines until it fits
      let [itemsPart, ...restParts] = body.split('\nCustomer Information:');
      let lines = itemsPart.split('\n');
      let truncated = 0;

      while (href.length > MAILTO_LIMIT && lines.length > 10) { // keep header + a few lines
        lines.splice(lines.length-2,1); // remove one item line near the end
        truncated++;
        const rebuiltItems = lines.join('\n') + `\n(+${truncated} more items truncated)\n`;
        body = rebuiltItems + '\nCustomer Information:' + restParts.join('\nCustomer Information:');
        href = makeMailto(body);
      }
    }
  }

  // robust attempt to open mail client
  try { 
    if (window.top !== window.self) window.top.location.href = href; else window.location.href = href;
  } catch(e) {
    try { window.location.href = href; }
    catch(e2){
      const a=document.createElement('a'); a.href=href; a.style.display='none'; document.body.appendChild(a); a.click(); a.remove();
      // last resort
      setTimeout(()=>alert('Your browser blocked opening the email app. Please open this page outside an embedded frame or email us at info@limitlessllc.com.'), 150);
    }
  }
}

// ...keep everything below as-is
</script>


// Initial render + payment note sync
renderCart();
setPaymentNote();
</script>
</body>
</html>
